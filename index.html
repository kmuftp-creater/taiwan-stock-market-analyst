<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­å€‹è‚¡è³‡æ–™åˆ†æç³»çµ±</title>
    
    <!-- PDF and Document Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Charting Library: ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        :root {
            --bg-grad-start: #2e3440; 
            --bg-grad-end: #1e222a; 
            --text-main: #eceff4;
            --text-light: #d8dee9; 
            --header-bg: rgba(20, 24, 30, 0.8);
            --card-bg: rgba(30, 35, 43, 0.85); 
            --input-bg: rgba(13, 17, 23, 0.5);
            --border-color: #4c566a;
            --primary-color: #88c0d0;
            --primary-hover: #81a1c1;
            --secondary-color: #5e81ac;
            --secondary-hover: #b48ead;
            --danger-color: #bf616a;
            --danger-hover: #ab525a; /* Added for red button hover */
            --warning-color: #d08770; /* Orange for download */
            --warning-hover: #e59d82;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --font-family: 'Inter', 'Noto Sans TC', sans-serif;
            --color-rise: #bf616a; /* Red for rise */
            --color-fall: #a3be8c; /* Green for fall */
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-image: linear-gradient(to bottom right, var(--bg-grad-start), var(--bg-grad-end));
            color: var(--text-main);
            line-height: 1.6;
        }

        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--input-bg);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-hover);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) var(--input-bg);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
            /* New gold gradient for high-quality look */
            background: linear-gradient(45deg, #F7DE98, #C0A062);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        header p {
            margin: 5px 0 0;
            color: var(--text-light);
            font-size: 1rem;
        }

        .grid-container {
            display: flex;
            gap: 25px;
            align-items: stretch; /* Make columns equal height */
        }

        #left-column {
            flex: 4; /* Approx 1/3 of width */
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 0; 
            overflow: hidden; 
        }
         .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px var(--shadow-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 2px solid var(--primary-color);
            padding: 25px 25px 10px 25px;
            transition: margin-bottom: 0.5s ease-in-out, border-color: 0.5s ease-in-out;
        }
        .card-header.collapsed {
            border-bottom-color: transparent;
            margin-bottom: 0;
        }
        
        .card-title {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .card-title svg {
            margin-right: 10px;
        }

        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: transform 0.3s ease, background-color: 0.2s;
        }
        .collapse-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .collapse-btn.collapsed {
            transform: rotate(-90deg);
        }

        .card-content {
            overflow: hidden;
            max-height: 2000px; /* Large value to ensure content is visible */
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 20px 25px 25px 25px;
        }
        .card-content.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }


        #data-display-card { 
            flex: 8; /* Approx 2/3 of width */
            display: flex; 
            flex-direction: column;
            padding: 25px;
            min-height: 0; /* Important for flex child to allow shrinking */
        }

        #tab-content-container {
            flex-grow: 1; /* Takes up remaining vertical space */
            overflow-y: auto; /* Adds a scrollbar when content overflows */
            min-height: 0; /* Also important for nested flex/scroll */
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }
        input[type="file"], input[type="text"], input[type="date"], input[type="password"], select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(136, 192, 208, 0.3);
        }
         input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* Style for file input button */
        input[type="file"]::file-selector-button {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color: 0.2s;
            font-size: 0.95rem;
            background-color: var(--secondary-color); /* Blue color */
            color: var(--text-main);
        }
        input[type="file"]::file-selector-button:hover {
            background-color: var(--secondary-hover);
        }

        button {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 0.95rem;
        }
        button:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #2e3440;
        }
        .btn-primary:hover { background-color: var(--primary-hover); }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-main);
        }
        .btn-secondary:hover { background-color: var(--secondary-hover); }

        .btn-danger {
            background-color: var(--danger-color);
            color: var(--text-main);
        }
        .btn-danger:hover { background-color: var(--danger-hover); }

        .btn-success {
            background-color: var(--color-fall);
            color: var(--bg-grad-start);
        }
        .btn-success:hover {
            background-color: #8fbcbb; /* Lighter green for hover */
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--bg-grad-start);
        }
        .btn-warning:hover {
            background-color: var(--warning-hover);
        }
        
        #data-table-container, #monthly-data-table-container, #backtest-trades-container {
            flex-grow: 1;
            overflow: auto; /* Use 'auto' to handle both vertical and horizontal scroll */
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        thead th {
            background-color: #3b4252;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tbody tr:hover {
            background-color: #3b4252;
        }

        #ai-result, #qa-result, #trump-result, #pattern-result, #financial-analysis-result, #fundamentals-result, #us-market-result {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--input-bg);
            border-radius: 8px;
            white-space: pre-wrap;
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
            line-height: 1.7;
            overflow-y: auto;
        }
        #expert-advice-result-container, #trump-result-container, #financial-analysis-result-container, #fundamentals-result-container, #us-market-result-container {
            margin-top: 20px;
            text-align: left;
            background-color: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            flex-grow: 1; /* Make the container grow */
            display: flex; /* Use flexbox to manage inner content */
            min-height: 0; /* Important for flex children scrolling */
        }
        #expert-advice-result, #trump-result, #financial-analysis-result, #fundamentals-result, #us-market-result {
            padding: 15px;
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.7;
            overflow-y: auto; /* Add a scrollbar when content overflows */
            flex-grow: 1; /* Make the result div fill the container */
            margin-top: 0;
            border: none;
        }

        .loader {
            display: none;
            border: 4px solid #4c566a;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #tts-btn.loading {
            cursor: not-allowed;
            opacity: 0.7;
        }
        #tts-btn .tts-icon { display: block; }
        #tts-btn.loading .tts-icon { display: none; }
        #tts-btn .tts-loader {
            display: none;
            border-width: 2px;
            width: 16px;
            height: 16px;
            border-top-color: var(--bg-grad-start);
            border-left-color: var(--bg-grad-start);
            border-right-color: var(--bg-grad-start);
        }
        #tts-btn.loading .tts-loader { display: block; }

        .status-message {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        #api-status { color: var(--text-light); }
        
        .chart-wrapper {
            margin-bottom: 20px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        .chart-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-main);
            margin: 0;
        }
        .chart-description {
            font-size: 0.85rem;
            color: var(--text-light);
            background-color: var(--input-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }
        .chart-description ul {
            padding-left: 20px;
            margin: 5px 0 0 0;
        }
        .chart-description li {
            margin-bottom: 5px;
        }

        .divider {
            border-top: 1px solid var(--border-color);
            margin: 25px 0;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 10px 15px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-light);
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-color 0.2s;
            font-size: 0.95rem;
        }
        .tab-btn:hover {
            color: var(--text-main);
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        #chart-period-selector {
            display: none; /* Hidden by default */
            text-align: right;
            margin-bottom: 10px;
        }
        .btn-period {
            padding: 5px 12px;
            font-size: 0.9rem;
            background-color: var(--secondary-color);
            color: var(--text-main);
            margin-left: 5px;
        }
        .btn-period:hover {
            background-color: var(--secondary-hover);
        }
        .btn-period.active {
            background-color: var(--primary-color);
            color: var(--bg-grad-start);
        }

        .text-rise { color: var(--color-rise); }
        .text-fall { color: var(--color-fall); }
        .text-no-change { color: var(--text-light); }

        #qa-citations {
            margin-top: 15px;
            font-size: 0.85rem;
        }
        #qa-citations h4 {
            margin: 0 0 5px 0;
            font-weight: 600;
        }
        #qa-citations a {
            color: var(--primary-color);
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }
        #qa-citations a:hover {
            text-decoration: underline;
        }

        .backtest-summary {
            display: flex;
            justify-content: space-around;
            background: var(--input-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-item h4 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }
        .summary-item p {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        #watchlist-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .watchlist-item {
            background-color: var(--warning-color);
            color: var(--bg-grad-start);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .watchlist-item:hover {
            background-color: var(--warning-hover);
        }
        .watchlist-item .remove-btn {
            background: none;
            border: none;
            color: var(--bg-grad-start);
            margin-left: 8px;
            padding: 0;
            font-size: 1.2rem;
            line-height: 1;
            opacity: 0.7;
        }

        /* æ™ºèƒ½è­¦ç¤ºç³»çµ±æ¨£å¼ */
        .alert-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .alert-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            background: var(--input-bg);
            animation: alertFadeIn 0.3s ease-out;
        }
        @keyframes alertFadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .alert-item.new {
            animation: alertPulse 1s ease-in-out 3;
        }
        .alert-item.bullish {
            border-left-color: var(--color-rise);
            background: rgba(191, 97, 106, 0.15);
        }
        .alert-item.bearish {
            border-left-color: var(--color-fall);
            background: rgba(163, 190, 140, 0.15);
        }
        .alert-item.warning {
            border-left-color: var(--warning-color);
            background: rgba(208, 135, 112, 0.15);
        }
        .alert-item.neutral {
            border-left-color: var(--primary-color);
            background: rgba(136, 192, 208, 0.15);
        }
        .alert-icon {
            font-size: 1.5rem;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .alert-content {
            flex-grow: 1;
        }
        .alert-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            color: var(--text-main);
        }
        .alert-description {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.4;
        }
        .alert-time {
            font-size: 0.75rem;
            color: var(--text-light);
            opacity: 0.7;
            margin-top: 4px;
        }
        .alert-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .alert-badge.buy {
            background: var(--color-rise);
            color: white;
        }
        .alert-badge.sell {
            background: var(--color-fall);
            color: white;
        }
        .alert-badge.watch {
            background: var(--warning-color);
            color: white;
        }
        .alert-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--input-bg);
            border-radius: 8px;
        }
        .alert-stat {
            text-align: center;
        }
        .alert-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .alert-stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
        }
        .alert-stat.bullish .alert-stat-value { color: var(--color-rise); }
        .alert-stat.bearish .alert-stat-value { color: var(--color-fall); }
        .alert-stat.warning .alert-stat-value { color: var(--warning-color); }
        .alert-stat.neutral .alert-stat-value { color: var(--primary-color); }
        .no-alerts {
            text-align: center;
            padding: 30px;
            color: var(--text-light);
        }
        .no-alerts svg {
            width: 48px;
            height: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* ç±Œç¢¼åˆ†ææ¨£å¼ */
        .chip-analysis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chip-card {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        .chip-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chip-data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .chip-data-row:last-child {
            border-bottom: none;
        }
        .chip-data-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }
        .chip-data-value {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .chip-data-value.positive {
            color: var(--color-rise);
        }
        .chip-data-value.negative {
            color: var(--color-fall);
        }
        .chip-summary-box {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }
        .chip-summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .chip-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            text-align: center;
        }
        .chip-summary-item {
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 12px;
        }
        .chip-summary-value {
            font-size: 1.3rem;
            font-weight: 700;
        }
        .chip-summary-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }
        .chip-ai-analysis {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        .chip-ai-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chip-trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .chip-trend-indicator.bullish {
            background: rgba(191, 97, 106, 0.2);
            color: var(--color-rise);
        }
        .chip-trend-indicator.bearish {
            background: rgba(163, 190, 140, 0.2);
            color: var(--color-fall);
        }
        .chip-trend-indicator.neutral {
            background: rgba(136, 192, 208, 0.2);
            color: var(--primary-color);
        }
        .chip-history-table {
            width: 100%;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        .chip-history-table th {
            background: var(--header-bg);
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }
        .chip-history-table td {
            padding: 8px 10px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        .chip-source-note {
            font-size: 0.75rem;
            color: var(--text-light);
            opacity: 0.7;
            margin-top: 15px;
            text-align: right;
        }
        .watchlist-item .remove-btn:hover {
            opacity: 1;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>å°ˆæ¥­å€‹è‚¡è³‡æ–™åˆ†æç³»çµ±</h1>
            <p>æ•´åˆå³æ™‚æŸ¥è©¢ã€åœ–è¡¨åˆ†æèˆ‡ AI æ´å¯Ÿï¼Œæ‰“é€ æ‚¨çš„ä¸€ç«™å¼æ±ºç­–ä¸­å¿ƒ</p>
        </header>

        <div class="grid-container">
            <div id="left-column">
                <div class="card" id="data-source-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            è³‡æ–™ä¾†æº
                        </h2>
                        <button class="collapse-btn" title="æ‘ºç–Š/å±•é–‹">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label for="file-upload">1. ä¸Šå‚³æ­·å²è³‡æ–™æ–‡ä»¶ (CSV)</label>
                            <input type="file" id="file-upload" accept=".csv">
                        </div>
                        
                        <div class="divider"></div>

                        <h3 style="font-weight:500; margin-bottom: 15px;">2. ç·šä¸ŠæŸ¥è©¢ä¸Šå¸‚å€‹è‚¡è³‡è¨Š</h3>
                        <div class="form-group">
                            <label for="stock-code-input">è‚¡ç¥¨ä»£è™Ÿ (åƒ…é™ä¸Šå¸‚)</label>
                            <input type="text" id="stock-code-input" placeholder="ä¾‹å¦‚: 2330">
                        </div>
                         <div class="form-group">
                            <label for="start-date-input">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" id="start-date-input">
                        </div>
                         <div class="form-group">
                            <label for="end-date-input">çµæŸæ—¥æœŸ</label>
                            <input type="date" id="end-date-input">
                        </div>
                        <button id="fetch-api-data-btn" class="btn-danger" style="width:100%;">
                            æŸ¥è©¢ä¸¦è¼‰å…¥è³‡æ–™
                        </button>
                        <div id="api-status" class="status-message"></div>

                        <div class="divider"></div>
                        <h3 style="font-weight:500; margin-bottom: 15px;">3. æˆ‘çš„è‡ªé¸è‚¡</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="watchlist-add-input" placeholder="è¼¸å…¥ä»£è™Ÿæ–°å¢..." style="flex-grow: 1;">
                            <button id="add-to-watchlist-btn" class="btn-secondary">æ–°å¢</button>
                        </div>
                        <div id="watchlist-container"></div>
                    </div>
                </div>

                <div class="card" id="ai-analysis-card">
                     <div class="card-header">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"></path><rect x="4" y="12" width="8" height="8"></rect><path d="M12 12v8H4"></path><path d="M16 4h4v4"></path><path d="M16 12h4v8"></path></svg>
                            AI æ™ºæ…§åˆ†æ
                        </h2>
                         <button class="collapse-btn" title="æ‘ºç–Š/å±•é–‹">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label for="api-key-input">æ‚¨çš„ Gemini API Key</label>
                            <input type="password" id="api-key-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ API Key">
                        </div>
                        <button id="validate-api-key-btn" class="btn-secondary" style="width:100%;">é©—è­‰ä¸¦ä½¿ç”¨é‡‘é‘°</button>
                        <p id="api-key-status" class="status-message"></p>
                        <div class="divider"></div>

                        <div class="form-group">
                            <label for="analysis-type">é¸æ“‡åˆ†ææ¨¡å‹ï¼š</label>
                            <select id="analysis-type">
                                <option value="summary">ç¸½é«”æ‘˜è¦</option>
                                <option value="technical">æŠ€è¡“æŒ‡æ¨™åˆ†æ</option>
                                <option value="fundamental">åŸºæœ¬é¢è§£è®€</option>
                                <option value="news">å¸‚å ´æ–°èæƒ…ç·’</option>
                                <option value="future">æœªä¾†è¶¨å‹¢é æ¸¬</option>
                            </select>
                        </div>
                        <button id="analyze-btn" class="btn-primary">å•Ÿå‹•åˆ†æ</button>
                        <div class="loader" id="ai-loader" style="margin: 15px auto 0;"></div>
                        <div id="ai-result-container" style="margin-top: 20px; display: none;">
                            <div style="display:flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-weight:500; margin:0;">åˆ†æçµæœï¼š</h3>
                                <div>
                                    <button id="tts-btn" class="btn-success" style="display:none;" title="æ’­æ”¾åˆ†æçµæœ">
                                        <svg class="tts-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                        <span class="tts-loader loader"></span>
                                    </button>
                                    <button id="download-ai-result-md-btn" class="btn-warning" style="display:none; margin-left: 10px;" title="ä¸‹è¼‰ Markdown å ±å‘Š">ä¸‹è¼‰ MD</button>
                                </div>
                            </div>
                            <div id="ai-result">è«‹å…ˆè¼‰å…¥è³‡æ–™ä¸¦é»æ“Šåˆ†ææŒ‰éˆ•ã€‚</div>
                        </div>
                    </div>
                </div>

                <div class="card" id="web-qa-card">
                     <div class="card-header">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            å€‹è‚¡ç¶²è·¯å•ç­”
                        </h2>
                         <button class="collapse-btn" title="æ‘ºç–Š/å±•é–‹">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label for="qa-input">é‡å°ç›®å‰å€‹è‚¡æå•ï¼š</label>
                            <input type="text" id="qa-input" placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘æœ‰ä»€éº¼é‡è¦è²¡å ±å—ï¼Ÿ">
                        </div>
                        <button id="qa-btn" class="btn-primary">ç¶²è·¯æå•</button>
                        <div class="loader" id="qa-loader" style="margin: 15px auto 0;"></div>
                        <div id="qa-result-container" style="margin-top: 20px; display: none;">
                            <div id="qa-result">è«‹å…ˆè¼‰å…¥å€‹è‚¡è³‡æ–™ä¸¦æå•ã€‚</div>
                            <div id="qa-citations"></div>
                            <button id="download-qa-result-md-btn" class="btn-warning" style="display:none; margin-top: 15px;">ä¸‹è¼‰ MD</button>
                        </div>
                    </div>
                </div>

                <!-- æ™ºèƒ½è­¦ç¤ºç³»çµ±å¡ç‰‡ -->
                <div class="card" id="smart-alert-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path><path d="M2 8c0-2.2.7-4.3 2-6"></path><path d="M22 8a10 10 0 0 0-2-6"></path></svg>
                            æ™ºèƒ½è­¦ç¤ºç³»çµ±
                        </h2>
                        <button class="collapse-btn" title="æ‘ºç–Š/å±•é–‹">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                    </div>
                    <div class="card-content">
                        <div id="alert-summary" class="alert-summary" style="display:none;">
                            <div class="alert-stat bullish">
                                <div class="alert-stat-value" id="bullish-count">0</div>
                                <div class="alert-stat-label">åå¤šè¨Šè™Ÿ</div>
                            </div>
                            <div class="alert-stat bearish">
                                <div class="alert-stat-value" id="bearish-count">0</div>
                                <div class="alert-stat-label">åç©ºè¨Šè™Ÿ</div>
                            </div>
                            <div class="alert-stat warning">
                                <div class="alert-stat-value" id="warning-count">0</div>
                                <div class="alert-stat-label">æ³¨æ„è¨Šè™Ÿ</div>
                            </div>
                            <div class="alert-stat neutral">
                                <div class="alert-stat-value" id="total-score">-</div>
                                <div class="alert-stat-label">ç¶œåˆè©•åˆ†</div>
                            </div>
                        </div>
                        <div id="alert-container" class="alert-container">
                            <div class="no-alerts">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                <p>è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™ä»¥ç²å–æ™ºèƒ½è­¦ç¤º</p>
                            </div>
                        </div>
                        <div id="alert-settings" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <details>
                                <summary style="cursor: pointer; color: var(--text-light); font-size: 0.85rem;">âš™ï¸ è­¦ç¤ºåƒæ•¸è¨­å®š</summary>
                                <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                                    <div>
                                        <label>RSI è¶…è²·é–¾å€¼</label>
                                        <input type="number" id="rsi-overbought" value="80" min="50" max="100" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label>RSI è¶…è³£é–¾å€¼</label>
                                        <input type="number" id="rsi-oversold" value="20" min="0" max="50" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label>KD è¶…è²·é–¾å€¼</label>
                                        <input type="number" id="kd-overbought" value="80" min="50" max="100" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label>KD è¶…è³£é–¾å€¼</label>
                                        <input type="number" id="kd-oversold" value="20" min="0" max="50" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label>æˆäº¤é‡æ”¾å¤§å€æ•¸</label>
                                        <input type="number" id="volume-multiplier" value="2" min="1" max="10" step="0.5" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label>å›çœ‹å¤©æ•¸</label>
                                        <input type="number" id="lookback-days" value="20" min="5" max="60" style="width: 100%;">
                                    </div>
                                </div>
                                <button id="refresh-alerts-btn" class="btn-secondary" style="width: 100%; margin-top: 10px;">é‡æ–°è¨ˆç®—è­¦ç¤º</button>
                            </details>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="data-display-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title" style="border:none; margin:0;">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                        åˆ†æä¸­å¿ƒ
                    </h2>
                    <button id="export-csv-btn" class="btn-success">åŒ¯å‡º CSV</button>
                </div>
                
                <div class="tabs">
                    <button class="tab-btn active" data-tab="data">è³‡æ–™é è¦½</button>
                    <button class="tab-btn" data-tab="main-charts">ä¸»è¦åœ–è¡¨</button>
                    <button class="tab-btn" data-tab="macd-kd-charts">MACD & KD</button>
                    <button class="tab-btn" data-tab="rsi-bias-charts">RSI, MFI & ä¹–é›¢ç‡</button>
                    <button class="tab-btn" data-tab="more-indicators">æ›´å¤šæŒ‡æ¨™</button>
                    <button class="tab-btn" data-tab="pattern">AI Kç·šå‹æ…‹</button>
                    <button class="tab-btn" data-tab="financial-analysis">AI è²¡å ±åˆ†æ</button>
                    <button class="tab-btn" data-tab="fundamentals">å€‹è‚¡æ¦‚æ³</button>
                    <button class="tab-btn" data-tab="chip-analysis">ğŸ“Š ç±Œç¢¼åˆ†æ</button>
                    <button class="tab-btn" data-tab="ai-expert">AIå°ˆå®¶å»ºè­°</button>
                    <button class="tab-btn" data-tab="trump">å·æ™®ä¸€å¥è©±</button>
                    <button class="tab-btn" data-tab="us-market">ç¾è‚¡åˆ†æ</button>
                    <button class="tab-btn" data-tab="pk">å€‹è‚¡æ¯”è¼ƒ (PK)</button>
                    <button class="tab-btn" data-tab="backtest">ç­–ç•¥å›æ¸¬</button>
                    <button class="tab-btn" data-tab="query">è³‡æ–™æŸ¥è©¢</button>
                </div>

                <div id="chart-period-selector">
                    <button class="btn-period active" data-period="day">æ—¥</button>
                    <button class="btn-period" data-period="week">å‘¨</button>
                    <button class="btn-period" data-period="month">æœˆ</button>
                </div>

                <div id="tab-content-container">
                    <div id="data-tab-content" class="tab-content active">
                        <div id="data-table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>é–‹ç›¤</th>
                                        <th>æœ€é«˜</th>
                                        <th>æœ€ä½</th>
                                        <th>æ”¶ç›¤</th>
                                        <th>æ¼²è·Œ</th>
                                        <th>æˆäº¤é‡</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body">
                                    <tr><td colspan="7" style="text-align:center; padding: 30px;">è«‹å…ˆè¼‰å…¥è³‡æ–™</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="main-charts-tab-content" class="tab-content">
                         <div class="chart-wrapper">
                             <div class="chart-header">
                                <h3 class="chart-title">è‚¡åƒ¹èˆ‡å¸ƒæ—é€šé“</h3>
                                <button class="btn-warning download-chart-btn" data-chart-id="main-chart" title="ä¸‹è¼‰åƒ¹æ ¼åœ–è¡¨" style="padding: 5px 10px; font-size: 0.8rem;">ä¸‹è¼‰åœ–è¡¨</button>
                            </div>
                            <div id="main-chart"></div>
                         </div>
                    </div>
                     <div id="macd-kd-charts-tab-content" class="tab-content">
                        <div class="chart-wrapper">
                            <div class="chart-header">
                                <h3 class="chart-title">MACD æŒ‡æ¨™ (DIF/MACD/OSC)</h3>
                                <button class="btn-warning download-chart-btn" data-chart-id="macd-chart">ä¸‹è¼‰åœ–è¡¨</button>
                            </div>
                            <div id="macd-chart"></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-header">
                                <h3 class="chart-title">éš¨æ©ŸæŒ‡æ¨™ (KD)</h3>
                                <button class="btn-warning download-chart-btn" data-chart-id="kd-chart">ä¸‹è¼‰åœ–è¡¨</button>
                            </div>
                            <div id="kd-chart"></div>
                        </div>
                    </div>
                    <div id="rsi-bias-charts-tab-content" class="tab-content">
                        <div class="chart-wrapper">
                            <div class="chart-header">
                                <h3 class="chart-title">ç›¸å°å¼·å¼±æŒ‡æ•¸ (RSI)</h3>
                                <button class="btn-warning download-chart-btn" data-chart-id="rsi-chart">ä¸‹è¼‰åœ–è¡¨</button>
                            </div>
                            <div id="rsi-chart"></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-header">
                                <h3 class="chart-title">è³‡é‡‘æµé‡æŒ‡æ¨™ (MFI)</h3>
                                <button class="btn-warning download-chart-btn" data-chart-id="mfi-chart">ä¸‹è¼‰åœ–è¡¨</button>
                            </div>
                            <div id="mfi-chart"></div>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-header">
                                <h3 class="chart-title">ä¹–é›¢ç‡ (BIAS)</h3>
                                <button class="btn-warning download-chart-btn" data-chart-id="bias-chart">ä¸‹è¼‰åœ–è¡¨</button>
                            </div>
                            <div id="bias-chart"></div>
                        </div>
                    </div>
                     <div id="more-indicators-tab-content" class="tab-content">
                        <div class="chart-wrapper">
                            <div class="chart-header">
                                <h3 class="chart-title">å¨å»‰æŒ‡æ¨™ (Williams %R)</h3>
                                <button class="btn-warning download-chart-btn" data-chart-id="williams-r-chart">ä¸‹è¼‰åœ–è¡¨</button>
                            </div>
                            <div id="williams-r-chart"></div>
                        </div>
                    </div>
                    <div id="pattern-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                            <button id="run-pattern-recognition-btn" class="btn-primary" style="margin-bottom: 20px; padding: 12px 24px; font-size: 1.1rem;">å•Ÿå‹• AI å‹æ…‹è¾¨è­˜</button>
                            <button id="download-pattern-md-btn" class="btn-warning" style="margin-bottom: 20px; padding: 12px 24px; font-size: 1.1rem; display: none;">ä¸‹è¼‰ MD</button>
                            <div class="loader" id="pattern-loader" style="margin: 20px auto 0;"></div>
                            <div id="pattern-result-container" style="display: none; flex-grow: 1; min-height: 0; display: flex; flex-direction: column;">
                                <div id="pattern-result"></div>
                                <div id="pattern-chart-wrapper" style="flex-grow: 1; min-height: 400px;">
                                    <div id="pattern-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div id="financial-analysis-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                             <div class="form-group">
                                <label for="financial-text-input">è²¼ä¸Šè²¡å ±ã€æ³•èªªæœƒæˆ–æ–°èç¨¿å…§å®¹ï¼š</label>
                                <textarea id="financial-text-input" rows="10" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå®Œæ•´çš„æ–‡å­—å…§å®¹..."></textarea>
                            </div>
                            <button id="analyze-financial-text-btn" class="btn-danger" style="margin-bottom: 20px;">å•Ÿå‹• AI è²¡å ±åˆ†æ</button>
                            <button id="download-financial-analysis-md-btn" class="btn-warning" style="margin-bottom: 20px; display: none;">ä¸‹è¼‰ MD</button>
                            <div class="loader" id="financial-analysis-loader" style="margin: 20px auto 0; flex-shrink: 0;"></div>
                            <div id="financial-analysis-result-container" style="display: none; flex-grow:1; min-height: 0;">
                                <div id="financial-analysis-result">è«‹è²¼ä¸Šæ–‡å­—ä¸¦é»æ“ŠæŒ‰éˆ•ä»¥ç”Ÿæˆåˆ†æã€‚</div>
                            </div>
                        </div>
                    </div>
                     <div id="fundamentals-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                            <button id="run-fundamentals-analysis-btn" class="btn-primary" style="margin-bottom: 20px; padding: 12px 24px; font-size: 1.1rem;">å•Ÿå‹• AI æ¦‚æ³åˆ†æ</button>
                            <button id="download-fundamentals-md-btn" class="btn-warning" style="margin-bottom: 20px; padding: 12px 24px; font-size: 1.1rem; display:none;">ä¸‹è¼‰ MD</button>
                            <div class="loader" id="fundamentals-loader" style="margin: 20px auto 0;"></div>
                            <div id="fundamentals-result-container" style="display: none; flex-grow: 1; min-height: 0;">
                                 <div id="fundamentals-result"></div>
                            </div>
                        </div>
                    </div>
                    <!-- ç±Œç¢¼åˆ†æ Tab -->
                    <div id="chip-analysis-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                                <button id="fetch-chip-data-btn" class="btn-primary" style="padding: 12px 24px; font-size: 1.1rem;">
                                    ğŸ“Š è¼‰å…¥ç±Œç¢¼è³‡æ–™
                                </button>
                                <button id="ai-chip-analysis-btn" class="btn-secondary" style="padding: 12px 24px; font-size: 1.1rem;">
                                    ğŸ¤– AI ç±Œç¢¼è§£è®€
                                </button>
                                <span id="chip-data-date" style="margin-left: auto; color: var(--text-light); font-size: 0.9rem;"></span>
                            </div>
                            
                            <div class="loader" id="chip-loader" style="margin: 20px auto 0; flex-shrink: 0;"></div>
                            
                            <div id="chip-analysis-result" style="display: none; flex-grow: 1; overflow-y: auto;">
                                <!-- ç±Œç¢¼æ‘˜è¦ -->
                                <div id="chip-summary-box" class="chip-summary-box">
                                    <div class="chip-summary-title">ğŸ“ˆ ç±Œç¢¼é¢ç¶œåˆè©•ä¼°</div>
                                    <div class="chip-summary-grid">
                                        <div class="chip-summary-item">
                                            <div class="chip-summary-value" id="chip-foreign">--</div>
                                            <div class="chip-summary-label">å¤–è³‡è²·è³£è¶…</div>
                                        </div>
                                        <div class="chip-summary-item">
                                            <div class="chip-summary-value" id="chip-trust">--</div>
                                            <div class="chip-summary-label">æŠ•ä¿¡è²·è³£è¶…</div>
                                        </div>
                                        <div class="chip-summary-item">
                                            <div class="chip-summary-value" id="chip-dealer">--</div>
                                            <div class="chip-summary-label">è‡ªç‡Ÿå•†è²·è³£è¶…</div>
                                        </div>
                                        <div class="chip-summary-item">
                                            <div class="chip-summary-value" id="chip-total">--</div>
                                            <div class="chip-summary-label">ä¸‰å¤§æ³•äººåˆè¨ˆ</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- è©³ç´°è³‡æ–™å¡ç‰‡ -->
                                <div class="chip-analysis-container">
                                    <!-- ä¸‰å¤§æ³•äººè²·è³£è¶… -->
                                    <div class="chip-card">
                                        <div class="chip-card-title">
                                            ğŸ¦ ä¸‰å¤§æ³•äººè²·è³£è¶…æ˜ç´°
                                        </div>
                                        <div id="institutional-details">
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">å¤–è³‡åŠé™¸è³‡(ä¸å«å¤–è³‡è‡ªç‡Ÿ)</span>
                                                <span class="chip-data-value" id="foreign-net">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">å¤–è³‡è‡ªç‡Ÿå•†</span>
                                                <span class="chip-data-value" id="foreign-dealer-net">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">æŠ•ä¿¡</span>
                                                <span class="chip-data-value" id="trust-net">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">è‡ªç‡Ÿå•†(è‡ªè¡Œè²·è³£)</span>
                                                <span class="chip-data-value" id="dealer-self-net">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">è‡ªç‡Ÿå•†(é¿éšª)</span>
                                                <span class="chip-data-value" id="dealer-hedge-net">--</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- èè³‡èåˆ¸ -->
                                    <div class="chip-card">
                                        <div class="chip-card-title">
                                            ğŸ’³ èè³‡èåˆ¸é¤˜é¡
                                        </div>
                                        <div id="margin-details">
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">èè³‡é¤˜é¡ (å¼µ)</span>
                                                <span class="chip-data-value" id="margin-buy-balance">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">èè³‡å¢æ¸›</span>
                                                <span class="chip-data-value" id="margin-buy-change">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">èåˆ¸é¤˜é¡ (å¼µ)</span>
                                                <span class="chip-data-value" id="margin-sell-balance">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">èåˆ¸å¢æ¸›</span>
                                                <span class="chip-data-value" id="margin-sell-change">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">åˆ¸è³‡æ¯”</span>
                                                <span class="chip-data-value" id="margin-ratio">--</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- å€Ÿåˆ¸è³‡æ–™ -->
                                    <div class="chip-card">
                                        <div class="chip-card-title">
                                            ğŸ“‰ å€Ÿåˆ¸è³£å‡º
                                        </div>
                                        <div id="borrow-details">
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">å€Ÿåˆ¸è³£å‡ºé¤˜é¡</span>
                                                <span class="chip-data-value" id="borrow-sell-balance">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">å€Ÿåˆ¸è³£å‡ºç•¶æ—¥å¢æ¸›</span>
                                                <span class="chip-data-value" id="borrow-sell-change">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">å€Ÿåˆ¸é¤˜é¡</span>
                                                <span class="chip-data-value" id="borrow-balance">--</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ç±Œç¢¼è¶¨å‹¢åˆ¤æ–· -->
                                    <div class="chip-card">
                                        <div class="chip-card-title">
                                            ğŸ¯ ç±Œç¢¼é¢è¨Šè™Ÿ
                                        </div>
                                        <div id="chip-signals">
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">æ³•äººæ…‹åº¦</span>
                                                <span class="chip-data-value" id="signal-institutional">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">æ•£æˆ¶å‹•å‘</span>
                                                <span class="chip-data-value" id="signal-retail">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">è»‹ç©ºé¢¨éšª</span>
                                                <span class="chip-data-value" id="signal-squeeze">--</span>
                                            </div>
                                            <div class="chip-data-row">
                                                <span class="chip-data-label">ç±Œç¢¼é›†ä¸­åº¦</span>
                                                <span class="chip-data-value" id="signal-concentration">--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- è¿‘æœŸç±Œç¢¼è®ŠåŒ–è¡¨æ ¼ -->
                                <div class="chip-card" style="margin-top: 20px;">
                                    <div class="chip-card-title">ğŸ“… è¿‘5æ—¥ä¸‰å¤§æ³•äººè²·è³£è¶…</div>
                                    <div style="overflow-x: auto;">
                                        <table class="chip-history-table">
                                            <thead>
                                                <tr>
                                                    <th>æ—¥æœŸ</th>
                                                    <th>å¤–è³‡</th>
                                                    <th>æŠ•ä¿¡</th>
                                                    <th>è‡ªç‡Ÿå•†</th>
                                                    <th>åˆè¨ˆ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="chip-history-body">
                                                <tr><td colspan="5" style="text-align:center; padding: 20px;">è¼‰å…¥ä¸­...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- AI ç±Œç¢¼åˆ†æçµæœ -->
                                <div id="chip-ai-result" class="chip-ai-analysis" style="display: none;">
                                    <div class="chip-ai-title">ğŸ¤– AI ç±Œç¢¼åˆ†æå ±å‘Š</div>
                                    <div id="chip-ai-content"></div>
                                </div>
                                
                                <div class="chip-source-note">
                                    è³‡æ–™ä¾†æºï¼šå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ TWSE | è³‡æ–™æ›´æ–°ï¼šT+1 ç›¤å¾Œæ›´æ–°
                                </div>
                            </div>
                            
                            <!-- åˆå§‹æç¤º -->
                            <div id="chip-placeholder" style="text-align: center; padding: 50px; color: var(--text-light);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5; margin-bottom: 15px;">
                                    <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path>
                                    <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path>
                                    <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>
                                </svg>
                                <p style="font-size: 1.1rem; margin-bottom: 10px;">è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™å¾Œï¼Œé»æ“Šã€Œè¼‰å…¥ç±Œç¢¼è³‡æ–™ã€</p>
                                <p style="font-size: 0.9rem; opacity: 0.7;">å°‡è‡ªå‹•å¾è­‰äº¤æ‰€å–å¾—ä¸‰å¤§æ³•äººè²·è³£è¶…ã€èè³‡èåˆ¸ç­‰ç±Œç¢¼è³‡è¨Š</p>
                            </div>
                        </div>
                    </div>
                    <div id="ai-expert-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                            <div style="text-align: center; flex-shrink: 0;">
                                <button id="generate-expert-advice-btn" class="btn-primary" style="padding: 12px 24px; font-size: 1.1rem;">ç”Ÿæˆ AI å°ˆå®¶å»ºè­°</button>
                                <button id="download-pdf-btn" class="btn-warning" disabled style="padding: 12px 24px; font-size: 1.1rem; margin-left: 10px; opacity: 0.5; cursor: not-allowed;">ä¸‹è¼‰ PDF å ±å‘Š</button>
                                <button id="download-expert-advice-md-btn" class="btn-success" disabled style="padding: 12px 24px; font-size: 1.1rem; margin-left: 10px; opacity: 0.5; cursor: not-allowed;">ä¸‹è¼‰ MD</button>
                            </div>
                            <div class="loader" id="expert-advice-loader" style="margin: 20px auto 0; flex-shrink: 0;"></div>
                            <div id="expert-advice-result-container" style="display: none;">
                                <div id="expert-advice-result">é»æ“ŠæŒ‰éˆ•ä»¥ç”Ÿæˆå°æœªä¾†èµ°å‹¢çš„é æ¸¬åˆ†æã€‚</div>
                            </div>
                        </div>
                    </div>
                    <div id="trump-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                             <div class="form-group">
                                <label for="trump-quote-input">è¼¸å…¥å·æ™®çš„ä¸€å¥è©± (ç•™ç©ºå¯è‡ªå‹•æœå°‹)ï¼š</label>
                                <textarea id="trump-quote-input" rows="3" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæˆ–è¼¸å…¥å·æ™®çš„è¨€è«–..."></textarea>
                            </div>
                            <button id="analyze-trump-quote-btn" class="btn-primary" style="margin-bottom: 20px;">å•Ÿå‹•åˆ†æ</button>
                            <button id="download-trump-result-md-btn" class="btn-warning" style="margin-bottom: 20px; display: none;">ä¸‹è¼‰ MD</button>
                            <div class="loader" id="trump-loader" style="margin: 20px auto 0; flex-shrink: 0;"></div>
                            <div id="trump-result-container" style="display: none;">
                                <div id="trump-result">è«‹è¼¸å…¥å¼•è¨€ä¸¦é»æ“ŠæŒ‰éˆ•ä»¥ç”Ÿæˆåˆ†æã€‚</div>
                            </div>
                        </div>
                    </div>
                    <div id="us-market-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                            <button id="run-us-market-analysis-btn" class="btn-primary" style="margin-bottom: 20px; padding: 12px 24px; font-size: 1.1rem;">å•Ÿå‹•ç¾è‚¡ç›¤å¾Œåˆ†æ</button>
                            <button id="download-us-market-md-btn" class="btn-warning" style="margin-bottom: 20px; padding: 12px 24px; font-size: 1.1rem; display:none;">ä¸‹è¼‰ MD</button>
                            <div class="loader" id="us-market-loader" style="margin: 20px auto 0; flex-shrink: 0;"></div>
                            <div id="us-market-result-container" style="display: none; flex-grow: 1; min-height: 0;">
                                 <div id="us-market-result"></div>
                            </div>
                        </div>
                    </div>
                     <div id="pk-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                             <div id="pk-form" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                                 <div class="form-group" style="flex: 1 1 120px; margin-bottom: 0;">
                                    <label for="pk-stock-code-1">è‚¡ç¥¨ä»£è™Ÿ 1</label>
                                    <input type="text" id="pk-stock-code-1" placeholder="ä¾‹å¦‚: 2330">
                                </div>
                                <div class="form-group" style="flex: 1 1 120px; margin-bottom: 0;">
                                    <label for="pk-stock-code-2">è‚¡ç¥¨ä»£è™Ÿ 2 (é¸å¡«)</label>
                                    <input type="text" id="pk-stock-code-2" placeholder="ä¾‹å¦‚: 2303">
                                </div>
                                <div class="form-group" style="flex: 1 1 120px; margin-bottom: 0;">
                                    <label for="pk-stock-code-3">è‚¡ç¥¨ä»£è™Ÿ 3 (é¸å¡«)</label>
                                    <input type="text" id="pk-stock-code-3" placeholder="ä¾‹å¦‚: 2454">
                                </div>
                                <div class="form-group" style="flex: 1 1 120px; margin-bottom: 0;">
                                    <label for="pk-stock-code-4">è‚¡ç¥¨ä»£è™Ÿ 4 (é¸å¡«)</label>
                                    <input type="text" id="pk-stock-code-4" placeholder="ä¾‹å¦‚: 2379">
                                </div>
                                <div class="form-group" style="flex: 1 1 150px; margin-bottom: 0;">
                                    <label for="pk-start-date">é–‹å§‹æ—¥æœŸ</label>
                                    <input type="date" id="pk-start-date">
                                </div>
                                <div class="form-group" style="flex: 1 1 150px; margin-bottom: 0;">
                                    <label for="pk-end-date">çµæŸæ—¥æœŸ</label>
                                    <input type="date" id="pk-end-date">
                                </div>
                                <button id="pk-compare-btn" class="btn-primary" style="flex-shrink: 0;">æ¯”è¼ƒ</button>
                            </div>
                            <div class="loader" id="pk-loader" style="margin: 30px auto;"></div>
                            <div id="pk-chart-container" style="flex-grow: 1; min-height: 400px;">
                                <p id="pk-status" style="text-align:center; padding: 30px; margin: auto;">è«‹è¼¸å…¥è‡³å°‘ä¸€æ”¯è‚¡ç¥¨ä»£è™Ÿä»¥é€²è¡Œæ¯”è¼ƒ</p>
                                <div id="pk-chart"></div>
                            </div>
                        </div>
                    </div>
                    <div id="backtest-tab-content" class="tab-content">
                        <div style="padding: 20px; display: flex; flex-direction: column; height: 100%;">
                            <div id="backtest-form" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-shrink: 0;">
                                 <div class="form-group" style="flex: 2; margin-bottom: 0;">
                                    <label for="initial-capital">åˆå§‹è³‡é‡‘</label>
                                    <input type="number" id="initial-capital" value="1000000">
                                </div>
                                <div class="form-group" style="flex: 3; margin-bottom: 0;">
                                    <label for="strategy-select">é¸æ“‡ç­–ç•¥</label>
                                    <select id="strategy-select">
                                        <option value="ma-crossover">MA5 / MA20 å‡ç·šäº¤å‰</option>
                                    </select>
                                </div>
                                <button id="run-backtest-btn" class="btn-primary">åŸ·è¡Œå›æ¸¬</button>
                            </div>
                            <div class="loader" id="backtest-loader" style="margin: 30px auto; flex-shrink: 0;"></div>
                            <div id="backtest-results-container" style="display: none; flex-grow: 1; min-height: 0; display: flex; flex-direction: column;">
                                <div id="backtest-summary-cards" class="backtest-summary"></div>
                                <div id="backtest-chart" style="flex-shrink: 0; margin-bottom: 20px;"></div>
                                <h3 style="margin: 10px 0;">äº¤æ˜“ç´€éŒ„</h3>
                                <div id="backtest-trades-container">
                                    <table id="backtest-trades-table">
                                        <thead>
                                            <tr>
                                                <th>è²·å…¥æ—¥æœŸ</th>
                                                <th>è²·å…¥åƒ¹æ ¼</th>
                                                <th>è³£å‡ºæ—¥æœŸ</th>
                                                <th>è³£å‡ºåƒ¹æ ¼</th>
                                                <th>æç›Š (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="backtest-trades-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="query-tab-content" class="tab-content">
                        <div id="monthly-query-form" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                             <div class="form-group" style="flex: 2; margin-bottom: 0;">
                                <label for="monthly-stock-code">è‚¡ç¥¨ä»£è™Ÿ (åƒ…é™ä¸Šå¸‚)</label>
                                <input type="text" id="monthly-stock-code" placeholder="ä¾‹å¦‚: 2330">
                            </div>
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <label for="query-year">å¹´ä»½</label>
                                <select id="query-year"></select>
                            </div>
                            <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                <label for="query-month">æœˆä»½</label>
                                <select id="query-month"></select>
                            </div>
                            <button id="monthly-query-btn" class="btn-primary">æŸ¥è©¢æœˆä»½è³‡æ–™</button>
                        </div>
                        <div id="monthly-query-result-container" style="flex-grow: 1; display: flex; flex-direction: column;">
                            <div class="loader" id="monthly-loader" style="margin: 30px auto;"></div>
                            <p id="monthly-query-status" style="text-align:center; padding: 30px; margin: auto;">è«‹è¼¸å…¥æ¢ä»¶ä»¥æŸ¥è©¢ç‰¹å®šæœˆä»½è³‡æ–™</p>
                            <div id="monthly-data-table-container" style="display:none;">
                                 <table>
                                    <thead>
                                        <tr>
                                            <th>æ—¥æœŸ</th>
                                            <th>é–‹ç›¤</th>
                                            <th>æœ€é«˜</th>
                                            <th>æœ€ä½</th>
                                            <th>æ”¶ç›¤</th>
                                            <th>æ¼²è·Œ</th>
                                            <th>æˆäº¤é‡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monthly-data-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    let originalStockData = [];
    let charts = {};
    let currentAudio = null;
    let userApiKey = "";
    let currentPeriod = 'day';
    let watchlist = [];

    // DOM Elements
    const fileUpload = document.getElementById('file-upload');
    const analyzeBtn = document.getElementById('analyze-btn');
    const aiResultDiv = document.getElementById('ai-result');
    const aiLoader = document.getElementById('ai-loader');
    const aiResultContainer = document.getElementById('ai-result-container');
    const dataTableBody = document.getElementById('data-table-body');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const ttsBtn = document.getElementById('tts-btn');
    
    // API Search Elements
    const stockCodeInput = document.getElementById('stock-code-input');
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');
    const fetchApiDataBtn = document.getElementById('fetch-api-data-btn');
    const apiStatus = document.getElementById('api-status');

    // Monthly Query Elements
    const monthlyStockCodeInput = document.getElementById('monthly-stock-code');
    const queryYearSelect = document.getElementById('query-year');
    const queryMonthSelect = document.getElementById('query-month');
    const monthlyQueryBtn = document.getElementById('monthly-query-btn');
    const monthlyLoader = document.getElementById('monthly-loader');
    const monthlyQueryStatus = document.getElementById('monthly-query-status');
    const monthlyDataTableContainer = document.getElementById('monthly-data-table-container');
    const monthlyDataTableBody = document.getElementById('monthly-data-table-body');

    // API Key Elements
    const apiKeyInput = document.getElementById('api-key-input');
    const validateApiKeyBtn = document.getElementById('validate-api-key-btn');
    const apiKeyStatus = document.getElementById('api-key-status');

    // Web QA Elements
    const qaInput = document.getElementById('qa-input');
    const qaBtn = document.getElementById('qa-btn');
    const qaLoader = document.getElementById('qa-loader');
    const qaResult = document.getElementById('qa-result');
    const qaResultContainer = document.getElementById('qa-result-container');
    const qaCitations = document.getElementById('qa-citations');
    
    // Chart period
    const chartPeriodSelector = document.getElementById('chart-period-selector');
    
    // AI Expert Advice Elements
    const generateExpertAdviceBtn = document.getElementById('generate-expert-advice-btn');
    const expertAdviceLoader = document.getElementById('expert-advice-loader');
    const expertAdviceResult = document.getElementById('expert-advice-result');
    const expertAdviceResultContainer = document.getElementById('expert-advice-result-container');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');

    // Trump Quote Elements
    const trumpQuoteInput = document.getElementById('trump-quote-input');
    const analyzeTrumpQuoteBtn = document.getElementById('analyze-trump-quote-btn');
    const trumpLoader = document.getElementById('trump-loader');
    const trumpResult = document.getElementById('trump-result');
    const trumpResultContainer = document.getElementById('trump-result-container');

    // PK Elements
    const pkStockCode1 = document.getElementById('pk-stock-code-1');
    const pkStockCode2 = document.getElementById('pk-stock-code-2');
    const pkStockCode3 = document.getElementById('pk-stock-code-3');
    const pkStockCode4 = document.getElementById('pk-stock-code-4');
    const pkStartDate = document.getElementById('pk-start-date');
    const pkEndDate = document.getElementById('pk-end-date');
    const pkCompareBtn = document.getElementById('pk-compare-btn');
    const pkLoader = document.getElementById('pk-loader');
    const pkStatus = document.getElementById('pk-status');
    const pkChartContainer = document.getElementById('pk-chart-container');
    const pkChart = document.getElementById('pk-chart');

    // Backtest Elements
    const runBacktestBtn = document.getElementById('run-backtest-btn');
    const backtestLoader = document.getElementById('backtest-loader');
    const backtestResultsContainer = document.getElementById('backtest-results-container');
    const backtestSummaryCards = document.getElementById('backtest-summary-cards');
    const backtestTradesBody = document.getElementById('backtest-trades-body');

    // Pattern Recognition Elements
    const runPatternRecognitionBtn = document.getElementById('run-pattern-recognition-btn');
    const patternLoader = document.getElementById('pattern-loader');
    const patternResultContainer = document.getElementById('pattern-result-container');
    const patternResult = document.getElementById('pattern-result');

    // Watchlist Elements
    const watchlistAddInput = document.getElementById('watchlist-add-input');
    const addToWatchlistBtn = document.getElementById('add-to-watchlist-btn');
    const watchlistContainer = document.getElementById('watchlist-container');

    // Financial Analysis Elements
    const financialTextInput = document.getElementById('financial-text-input');
    const analyzeFinancialTextBtn = document.getElementById('analyze-financial-text-btn');
    const financialAnalysisLoader = document.getElementById('financial-analysis-loader');
    const financialAnalysisResultContainer = document.getElementById('financial-analysis-result-container');
    const financialAnalysisResult = document.getElementById('financial-analysis-result');
    
    // Fundamentals Elements
    const runFundamentalsAnalysisBtn = document.getElementById('run-fundamentals-analysis-btn');
    const fundamentalsLoader = document.getElementById('fundamentals-loader');
    const fundamentalsResultContainer = document.getElementById('fundamentals-result-container');
    const fundamentalsResult = document.getElementById('fundamentals-result');

    // US Market Analysis Elements
    const runUsMarketAnalysisBtn = document.getElementById('run-us-market-analysis-btn');
    const usMarketLoader = document.getElementById('us-market-loader');
    const usMarketResultContainer = document.getElementById('us-market-result-container');
    const usMarketResult = document.getElementById('us-market-result');


    // --- Initialization ---
    window.onload = () => {
        initDates();
        populateDateSelects();
        initializeApiKeyStatus();
        addDownloadButtonListeners();
        loadWatchlist();
        renderWatchlist();
    };
    
    function initDates() {
        const today = new Date();
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(today.getMonth() - 3); // Default to 3 months
        const todayStr = today.toISOString().split('T')[0];
        const threeMonthsAgoStr = threeMonthsAgo.toISOString().split('T')[0];
        
        endDateInput.value = todayStr;
        startDateInput.value = threeMonthsAgoStr;
        pkEndDate.value = todayStr;
        pkStartDate.value = threeMonthsAgoStr;
    }

    function populateDateSelects() {
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;

        for (let year = currentYear; year >= 2000; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            queryYearSelect.appendChild(option);
        }

        for (let month = 1; month <= 12; month++) {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            queryMonthSelect.appendChild(option);
        }
        queryYearSelect.value = currentYear;
        queryMonthSelect.value = currentMonth;
    }

    // --- Event Listeners ---
    fileUpload.addEventListener('change', handleFileUpload);
    analyzeBtn.addEventListener('click', handleAnalysis);
    exportCsvBtn.addEventListener('click', exportData);
    ttsBtn.addEventListener('click', playTTS);
    fetchApiDataBtn.addEventListener('click', () => {
        const stockCode = stockCodeInput.value.trim();
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        fetchAndDisplaySingleStock(stockCode, startDate, endDate);
    });
    monthlyQueryBtn.addEventListener('click', handleMonthlyQuery);
    validateApiKeyBtn.addEventListener('click', handleApiKeyValidation);
    qaBtn.addEventListener('click', handleWebQa);
    generateExpertAdviceBtn.addEventListener('click', handleExpertAdvice);
    downloadPdfBtn.addEventListener('click', generatePdfReport);
    analyzeTrumpQuoteBtn.addEventListener('click', handleTrumpQuoteAnalysis);
    pkCompareBtn.addEventListener('click', handlePkCompare);
    runBacktestBtn.addEventListener('click', handleBacktest);
    runPatternRecognitionBtn.addEventListener('click', handlePatternRecognition);
    addToWatchlistBtn.addEventListener('click', addToWatchlist);
    analyzeFinancialTextBtn.addEventListener('click', handleFinancialAnalysis);
    runFundamentalsAnalysisBtn.addEventListener('click', handleFundamentalsAnalysis);
    runUsMarketAnalysisBtn.addEventListener('click', handleUsMarketAnalysis);

    // MD Download Listeners
    document.getElementById('download-ai-result-md-btn').addEventListener('click', () => downloadMarkdown('ai-result', 'AIæ™ºæ…§åˆ†æå ±å‘Š'));
    document.getElementById('download-qa-result-md-btn').addEventListener('click', () => downloadMarkdown('qa-result', 'å€‹è‚¡ç¶²è·¯å•ç­”'));
    document.getElementById('download-expert-advice-md-btn').addEventListener('click', () => downloadMarkdown('expert-advice-result', 'AIå°ˆå®¶å»ºè­°å ±å‘Š'));
    document.getElementById('download-trump-result-md-btn').addEventListener('click', () => downloadMarkdown('trump-result', 'å·æ™®ä¸€å¥è©±åˆ†æ'));
    document.getElementById('download-financial-analysis-md-btn').addEventListener('click', () => downloadMarkdown('financial-analysis-result', 'AIè²¡å ±åˆ†æ'));
    document.getElementById('download-fundamentals-md-btn').addEventListener('click', () => downloadMarkdown('fundamentals-result', 'å€‹è‚¡æ¦‚æ³åˆ†æ'));
    document.getElementById('download-pattern-md-btn').addEventListener('click', () => downloadMarkdown('pattern-result', 'AIå‹æ…‹è¾¨è­˜å ±å‘Š'));
    document.getElementById('download-us-market-md-btn').addEventListener('click', () => downloadMarkdown('us-market-result', 'ç¾è‚¡åˆ†æå ±å‘Š'));


    // Tab switching logic
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            button.classList.add('active');
            const tabId = button.dataset.tab;
            document.getElementById(`${tabId}-tab-content`).classList.add('active');
            
            const isChartTab = ['main-charts', 'rsi-bias-charts', 'macd-kd-charts', 'more-indicators'].includes(tabId);
            chartPeriodSelector.style.display = isChartTab ? 'block' : 'none';

            if (isChartTab && originalStockData.length > 0) {
                setTimeout(() => { updateCharts(currentPeriod); }, 10);
            }
        });
    });

    // Chart Period Selector
    chartPeriodSelector.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const period = e.target.dataset.period;
            if (period !== currentPeriod) {
                currentPeriod = period;
                chartPeriodSelector.querySelectorAll('.btn-period').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                updateCharts(currentPeriod);
            }
        }
    });

    // Collapsible Card Logic
    document.querySelectorAll('.card-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            const buttonIcon = header.querySelector('.collapse-btn');
            if (content && content.classList.contains('card-content')) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
                if (buttonIcon) buttonIcon.classList.toggle('collapsed');
            }
        });
    });


    // --- API Key Management ---
    function initializeApiKeyStatus() {
        apiKeyStatus.textContent = 'å°šæœªè¨­å®š API é‡‘é‘°ã€‚';
        apiKeyStatus.style.color = 'var(--text-light)';
    }

    async function handleApiKeyValidation() {
        const key = apiKeyInput.value.trim();
        if (!key) {
            apiKeyStatus.textContent = 'è«‹è¼¸å…¥æ‚¨çš„ API é‡‘é‘°ã€‚';
            apiKeyStatus.style.color = 'var(--danger-color)';
            return;
        }

        apiKeyStatus.textContent = 'æ­£åœ¨é©—è­‰é‡‘é‘°...';
        apiKeyStatus.style.color = 'var(--text-light)';

        const isValid = await validateApiKey(key);

        if (isValid) {
            userApiKey = key;
            apiKeyStatus.textContent = 'é‡‘é‘°é©—è­‰æˆåŠŸï¼Œæœ¬æ¬¡é€£ç·šæœ‰æ•ˆï¼';
            apiKeyStatus.style.color = 'var(--color-fall)'; // Green
        } else {
            userApiKey = ""; // Clear invalid key
            apiKeyStatus.textContent = 'é‡‘é‘°é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œé‡è©¦ã€‚';
            apiKeyStatus.style.color = 'var(--danger-color)';
        }
    }

    async function validateApiKey(key) {
        const validationUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
        try {
            const response = await fetch(validationUrl, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            if (response.ok) {
                return true;
            } else {
                console.error(`API Key validation failed with status: ${response.status}`);
                return false;
            }
        } catch (error) {
            console.error("Error during API key validation:", error);
            return false;
        }
    }

    // --- Watchlist Functions ---
    function loadWatchlist() {
        const storedWatchlist = localStorage.getItem('stockWatchlist');
        if (storedWatchlist) {
            watchlist = JSON.parse(storedWatchlist);
        }
    }

    function saveWatchlist() {
        localStorage.setItem('stockWatchlist', JSON.stringify(watchlist));
    }

    function renderWatchlist() {
        watchlistContainer.innerHTML = '';
        watchlist.forEach(stock => {
            const item = document.createElement('div');
            item.className = 'watchlist-item';
            item.textContent = `${stock.name} (${stock.code})`;
            item.dataset.code = stock.code;
            item.title = `æŸ¥è©¢ ${stock.name} (${stock.code})`;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = `ç§»é™¤ ${stock.code}`;
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeFromWatchlist(stock.code);
            };
            
            item.appendChild(removeBtn);
            item.onclick = () => {
                stockCodeInput.value = stock.code;
                fetchApiDataBtn.click();
            };
            watchlistContainer.appendChild(item);
        });
    }
    
    async function getStockName(code) {
        const today = new Date();
        const monthStr = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}`;
        const result = await fetchDataForMonth(code, monthStr);
        if (result && result.stat === "OK" && result.title) {
            const parts = result.title.split(' ');
            if (parts.length > 2) {
                return parts[2];
            }
        }
        throw new Error('ç„¡æ³•æ‰¾åˆ°è©²è‚¡ç¥¨åç¨±ï¼Œè«‹ç¢ºèªä»£è™Ÿæ˜¯å¦æ­£ç¢º');
    }


    async function addToWatchlist() {
        const code = watchlistAddInput.value.trim();
        if (!code || !/^\d{4,6}$/.test(code)) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£è™Ÿã€‚');
            return;
        }
        if (watchlist.some(stock => stock.code === code)) {
            alert(`ä»£è™Ÿ ${code} å·²åœ¨è‡ªé¸è‚¡æ¸…å–®ä¸­ã€‚`);
            watchlistAddInput.value = '';
            return;
        }
        
        addToWatchlistBtn.disabled = true;
        addToWatchlistBtn.textContent = 'æŸ¥è©¢ä¸­...';

        try {
            const name = await getStockName(code);
            watchlist.push({ code: code, name: name });
            watchlist.sort((a, b) => a.code.localeCompare(b.code)); // Sort by code
            saveWatchlist();
            renderWatchlist();
            watchlistAddInput.value = '';
        } catch(error) {
            alert(`æ–°å¢å¤±æ•—ï¼š${error.message}`);
        } finally {
            addToWatchlistBtn.disabled = false;
            addToWatchlistBtn.textContent = 'æ–°å¢';
        }
    }

    function removeFromWatchlist(codeToRemove) {
        watchlist = watchlist.filter(stock => stock.code !== codeToRemove);
        saveWatchlist();
        renderWatchlist();
    }


    // --- 1. Data Fetching and Loading ---
    
    async function fetchStockData(stockCode, startDate, endDate, market = 'tse') {
        const months = getMonthsInRange(new Date(startDate), new Date(endDate));
        const fetchPromises = months.map(month => fetchDataForMonth(stockCode, month, market));
        const monthlyResults = await Promise.all(fetchPromises);

        let allData = [];
        let stockInfo = { code: stockCode, name: '' };
        monthlyResults.forEach(result => {
            if (result && result.stat === "OK" && result.data) {
                allData.push(...result.data);
                if (!stockInfo.name && result.title) {
                    stockInfo.name = result.title.split(' ')[2];
                }
            }
        });

        if (allData.length === 0) {
             throw new Error(`æ‰¾ä¸åˆ° ${stockCode} ã®è³‡æ–™ï¼Œè«‹ç¢ºèªä»£è™Ÿèˆ‡å¸‚å ´åˆ¥æ˜¯å¦æ­£ç¢ºã€‚`);
        }

        const filteredData = filterAndFormatData(allData, startDate, endDate);
        
        if (filteredData.length === 0) {
            throw new Error('æ‚¨é¸æ“‡çš„æ—¥æœŸç¯„åœå…§æ²’æœ‰äº¤æ˜“è³‡æ–™ã€‚');
        }
        
        return transformTwseData(filteredData, stockInfo);
    }

    async function fetchAndDisplaySingleStock(stockCode, startDate, endDate) {
        if (!stockCode || !startDate || !endDate) {
            apiStatus.textContent = 'éŒ¯èª¤ï¼šè«‹å¡«å¯«æ‰€æœ‰æŸ¥è©¢æ¬„ä½ã€‚';
            apiStatus.style.color = 'var(--danger-color)';
            return;
        }
        if (new Date(startDate) > new Date(endDate)) {
            apiStatus.textContent = 'éŒ¯èª¤ï¼šé–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚';
            apiStatus.style.color = 'var(--danger-color)';
            return;
        }

        apiStatus.textContent = `æ­£åœ¨æŠ“å–è³‡æ–™...`;
        apiStatus.style.color = 'var(--text-light)';
        
        try {
            const transformedData = await fetchStockData(stockCode, startDate, endDate);
            originalStockData = transformedData;
            saveDataToStorage();
            processAndDisplayData();
            
            apiStatus.textContent = `æˆåŠŸè¼‰å…¥ ${transformedData[0].stockName} (${transformedData[0].stockCode}) ã® ${transformedData.length} ç­†è³‡æ–™ã€‚`;
            apiStatus.style.color = 'var(--secondary-color)';

        } catch (error) {
            console.error('ç·šä¸ŠæŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            apiStatus.textContent = `æŸ¥è©¢å¤±æ•—: ${error.message}`;
            apiStatus.style.color = 'var(--danger-color)';
        }
    }

    async function handleMonthlyQuery() {
        const stockCode = monthlyStockCodeInput.value.trim();
        const year = queryYearSelect.value;
        const month = queryMonthSelect.value.padStart(2, '0');
        const market = 'tse'; // Hardcoded to TSE

        if (!stockCode) {
            monthlyQueryStatus.textContent = 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚';
            monthlyQueryStatus.style.color = 'var(--danger-color)';
            monthlyQueryStatus.style.display = 'block';
            monthlyDataTableContainer.style.display = 'none';
            return;
        }
        
        monthlyLoader.style.display = 'block';
        monthlyQueryStatus.style.display = 'none';
        monthlyDataTableContainer.style.display = 'none';

        try {
            const monthStr = `${year}${month}`;
            const result = await fetchDataForMonth(stockCode, monthStr, market);
            if (result.stat === 'OK' && result.data && result.data.length > 0) {
                displayMonthlyData(result.data);
                monthlyDataTableContainer.style.display = 'block';
            } else {
                throw new Error(`æ­¤æœˆä»½æŸ¥ç„¡è³‡æ–™æˆ–ä»£è™ŸéŒ¯èª¤ã€‚`);
            }
        } catch (error) {
            monthlyQueryStatus.textContent = `æŸ¥è©¢å¤±æ•—ï¼š${error.message}`;
            monthlyQueryStatus.style.color = 'var(--danger-color)';
            monthlyQueryStatus.style.display = 'block';
        } finally {
            monthlyLoader.style.display = 'none';
        }
    }

    function getMonthsInRange(startDate, endDate) {
        const months = new Set();
        let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
        const lastDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
        while (currentDate <= lastDate) {
            const year = currentDate.getFullYear();
            const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            months.add(`${year}${month}`);
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
        return Array.from(months);
    }
    
    async function fetchDataForMonth(stockCode, month) {
        const dateStr = `${month}01`;
        const apiUrl = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${stockCode}`;
        
        // å¤šé‡ä»£ç†ä¼ºæœå™¨å‚™æ´
        const proxies = [
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
        ];
        
        await new Promise(resolve => setTimeout(resolve, 300)); // Rate limiting

        let lastError = null;
        for (const getProxyUrl of proxies) {
            try {
                const proxyUrl = getProxyUrl(apiUrl);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(proxyUrl, { 
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' }
                });
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && (data.data || data.stat === 'OK')) {
                        return data;
                    }
                }
            } catch (e) {
                lastError = e;
                console.log(`Proxy failed, trying next...`, e.message);
            }
        }
        
        throw new Error(`æ‰€æœ‰ä»£ç†ä¼ºæœå™¨çš†ç„¡æ³•é€£æ¥ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–ä½¿ç”¨ä¸Šå‚³ CSV åŠŸèƒ½`);
    }

    function filterAndFormatData(data, startDate, endDate) {
        const start = new Date(startDate);
        start.setHours(0, 0, 0, 0);  // é–‹å§‹æ—¥æœŸ 00:00:00
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);  // çµæŸæ—¥æœŸ 23:59:59.999
        return data.map(item => {
            const rocDate = item[0].trim();
            const [rocYear, month, day] = rocDate.split('/');
            const year = parseInt(rocYear, 10) + 1911;
            const gregorianDate = new Date(year, parseInt(month, 10) - 1, parseInt(day, 10));
            gregorianDate.setHours(0, 0, 0, 0);  // ç¢ºä¿æ¯”è¼ƒæ™‚ä¸€è‡´
            return { dateObj: gregorianDate, rocDate: rocDate, data: item };
        }).filter(item => item.dateObj >= start && item.dateObj <= end)
          .sort((a, b) => a.dateObj - b.dateObj);
    }

    function transformTwseData(twseData, stockInfo) {
        return twseData.map(item => {
            const d = item.data;
            // ä½¿ç”¨æœ¬åœ°æ™‚é–“è€Œä¸æ˜¯ ISO å­—ç¬¦ä¸²ï¼Œé¿å…æ™‚å€è½‰æ›å°è‡´æ—¥æœŸåç§»
            const year = item.dateObj.getFullYear();
            const month = String(item.dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(item.dateObj.getDate()).padStart(2, '0');
            return {
                rocDate: item.rocDate,
                stockCode: stockInfo.code,
                stockName: stockInfo.name,
                date: `${year}-${month}-${day}`,
                volume: parseInt(String(d[1]).replace(/,/g, ''), 10),
                amount: parseInt(String(d[2]).replace(/,/g, ''), 10),
                open: parseFloat(String(d[3]).replace(/,/g, '')),
                high: parseFloat(String(d[4]).replace(/,/g, '')),
                low: parseFloat(String(d[5]).replace(/,/g, '')),
                close: parseFloat(String(d[6]).replace(/,/g, '')),
                change: String(d[7]).replace(/,/g, ''),
                transactions: parseInt(String(d[8]).replace(/,/g, ''), 10)
            };
        });
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file && file.type === 'text/csv') {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                const parsedData = parseCsv(csvText);
                if (parsedData.length > 0) {
                    originalStockData = parsedData;
                    saveDataToStorage();
                    processAndDisplayData();
                } else {
                    alert("ç„¡æ³•è§£æ CSV æª”æ¡ˆï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
                }
            };
            reader.readAsText(file);
        } else {
            alert("è«‹ä¸Šå‚³ CSV æ ¼å¼çš„æª”æ¡ˆã€‚");
        }
    }
    
    function parseCsv(csvText) {
        const lines = csvText.trim().split('\n');
        let dataStartIndex = 0;
        while(dataStartIndex < lines.length && !/^\d{3}\/\d{2}\/\d{2}/.test(lines[dataStartIndex])) {
            dataStartIndex++;
        }

        const data = [];
        const stockInfo = { code: 'N/A', name: 'N/A' };
        
        if (dataStartIndex > 0) {
            const headerLine = lines[dataStartIndex-2] || "";
            const match = headerLine.match(/(\d{4,})\s(.+?),/);
            if (match) {
                stockInfo.code = match[1];
                stockInfo.name = match[2].trim();
            }
        }
        
        for (let i = dataStartIndex; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
            if (values.length >= 9) {
                const [rocDate, volume, amount, open, high, low, close, change, transactions] = values;
                const [rocYear, month, day] = rocDate.split('/');
                const year = parseInt(rocYear, 10) + 1911;

                data.push({
                    rocDate: rocDate,
                    stockCode: stockInfo.code,
                    stockName: stockInfo.name,
                    date: new Date(year, month - 1, day).toISOString().split('T')[0],
                    volume: parseInt(volume.replace(/,/g, '')),
                    amount: parseInt(amount.replace(/,/g, '')),
                    open: parseFloat(open.replace(/,/g, '')),
                    high: parseFloat(high.replace(/,/g, '')),
                    low: parseFloat(low.replace(/,/g, '')),
                    close: parseFloat(close.replace(/,/g, '')),
                    change: change.replace(/,/g, ''),
                    transactions: parseInt(transactions.replace(/,/g, ''))
                });
            }
        }
        return data;
    }


    // --- 2. Data Processing and Display ---

    function processAndDisplayData() {
        if (!originalStockData || originalStockData.length === 0) return;
        updateDataDisplay();
        updateCharts(currentPeriod);
    }

    function updateCharts(period) {
        if (!originalStockData || originalStockData.length === 0) return;

        let dataToProcess;
        // Always create a deep copy to prevent modification of the original data
        const freshData = JSON.parse(JSON.stringify(originalStockData));

        if (period === 'day') {
            dataToProcess = freshData;
        } else {
            dataToProcess = aggregateData(freshData, period);
        }
        
        processStockData(dataToProcess);
        renderAllCharts(dataToProcess);
        calculateSmartAlerts(originalStockData); // è¨ˆç®—æ™ºèƒ½è­¦ç¤º
    }
    
    function updateDataDisplay() {
        dataTableBody.innerHTML = '';
        if (!originalStockData || originalStockData.length === 0) {
            dataTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 30px;">è«‹å…ˆè¼‰å…¥è³‡æ–™</td></tr>`;
            return;
        }
        const reversedData = [...originalStockData].reverse();
        reversedData.forEach(d => {
            const row = createDataRow(d);
            dataTableBody.appendChild(row);
        });
    }

    function displayMonthlyData(data) {
        monthlyDataTableBody.innerHTML = '';
        data.forEach(item => {
            const rocDate = item[0].trim();
            const [rocYear, month, day] = rocDate.split('/');
            const year = parseInt(rocYear, 10) + 1911;

            const formattedItem = {
                date: new Date(year, month - 1, day).toISOString().split('T')[0],
                open: parseFloat(String(item[3]).replace(/,/g, '')),
                high: parseFloat(String(item[4]).replace(/,/g, '')),
                low: parseFloat(String(item[5]).replace(/,/g, '')),
                close: parseFloat(String(item[6]).replace(/,/g, '')),
                change: String(item[7]).replace(/,/g, ''),
                volume: parseInt(String(item[1]).replace(/,/g, ''), 10) * 1000
            };
            const row = createDataRow(formattedItem);
            monthlyDataTableBody.appendChild(row);
        });
    }

    function createDataRow(d) {
        const row = document.createElement('tr');
        const changeValue = parseFloat(d.change);
        let changeClass = 'text-no-change';
        if (changeValue > 0) changeClass = 'text-rise';
        else if (changeValue < 0) changeClass = 'text-fall';
        
        let changeText = d.change;
        if (changeValue > 0 && !String(changeText).startsWith('+')) {
            changeText = `+${changeText}`;
        }

        row.innerHTML = `
            <td>${d.date}</td>
            <td>${d.open}</td>
            <td>${d.high}</td>
            <td>${d.low}</td>
            <td class="${changeClass}">${d.close}</td>
            <td class="${changeClass}">${changeText}</td>
            <td>${d.volume ? d.volume.toLocaleString() : 'N/A'}</td>
        `;
        return row;
    }
    
    function aggregateData(sourceData, period) {
        if (period === 'day') return sourceData;

        const getPeriodKey = (dateStr) => {
            const d = new Date(dateStr);
            if (period === 'week') {
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday
                return new Date(d.setDate(diff)).toISOString().split('T')[0];
            }
            if (period === 'month') {
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`;
            }
        };

        const groupedData = sourceData.reduce((acc, curr) => {
            const key = getPeriodKey(curr.date);
            if (!acc[key]) {
                acc[key] = [];
            }
            acc[key].push(curr);
            return acc;
        }, {});

        return Object.keys(groupedData).map(key => {
            const group = groupedData[key];
            const first = group[0];
            const last = group[group.length - 1];
            return {
                date: key,
                open: first.open,
                high: Math.max(...group.map(d => d.high)),
                low: Math.min(...group.map(d => d.low)),
                close: last.close,
                volume: group.reduce((sum, d) => sum + d.volume, 0),
                // ROC date and other fields might not be applicable
                rocDate: last.rocDate,
                stockCode: first.stockCode,
                stockName: first.stockName
            };
        });
    }


    function processStockData(data) {
        // MA
        const maPeriods = [5, 6, 10, 20];
        maPeriods.forEach(period => {
            for (let i = 0; i < data.length; i++) {
                if (i >= period - 1) {
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i - j].close;
                    }
                    data[i]['ma' + period] = (sum / period).toFixed(2);
                } else {
                    data[i]['ma' + period] = null;
                }
            }
        });
        
        // Bollinger Bands
        const bbPeriod = 20;
        const bbMultiplier = 2;
        for (let i = 0; i < data.length; i++) {
            if (i >= bbPeriod - 1) {
                const slice = data.slice(i - bbPeriod + 1, i + 1);
                const mean = parseFloat(data[i].ma20);
                const stdDev = Math.sqrt(slice.map(d => Math.pow(d.close - mean, 2)).reduce((a, b) => a + b) / bbPeriod);
                data[i].bb_upper = (mean + (stdDev * bbMultiplier)).toFixed(2);
                data[i].bb_lower = (mean - (stdDev * bbMultiplier)).toFixed(2);
            } else {
                data[i].bb_upper = null;
                data[i].bb_lower = null;
            }
        }
        
        // BIAS
        const biasPeriod = 6;
        for (let i = 0; i < data.length; i++) {
            if (data[i].ma6) {
                data[i].bias = (((data[i].close - data[i].ma6) / data[i].ma6) * 100).toFixed(2);
            } else {
                data[i].bias = null;
            }
        }

        // RSI
        let gains = 0, losses = 0;
        const rsiPeriod = 14;
        for (let i = 1; i < data.length; i++) {
            const change = data[i].close - data[i - 1].close;
            if (i < rsiPeriod) {
                if (change > 0) gains += change;
                else losses -= change;
            } else if (i === rsiPeriod) {
                gains /= rsiPeriod;
                losses /= rsiPeriod;
            } else {
                if (change > 0) gains = (gains * (rsiPeriod - 1) + change) / rsiPeriod;
                else losses = (losses * (rsiPeriod - 1) - change) / rsiPeriod;
            }
            if (i >= rsiPeriod -1) {
                const rs = losses === 0 ? 100 : gains / losses;
                data[i].rsi = (100 - (100 / (1 + rs))).toFixed(2);
            } else {
                data[i].rsi = null;
            }
        }

        // MFI
        const mfiPeriod = 14;
        for (let i = 0; i < data.length; i++) {
            data[i].mfi = null; 
            if (i > 0) {
                const typicalPrice = (data[i].high + data[i].low + data[i].close) / 3;
                const prevTypicalPrice = (data[i-1].high + data[i-1].low + data[i-1].close) / 3;
                const rawMoneyFlow = typicalPrice * data[i].volume;
                
                data[i].positiveMoneyFlow = (typicalPrice > prevTypicalPrice) ? rawMoneyFlow : 0;
                data[i].negativeMoneyFlow = (typicalPrice < prevTypicalPrice) ? rawMoneyFlow : 0;
            } else {
                data[i].positiveMoneyFlow = 0;
                data[i].negativeMoneyFlow = 0;
            }
        }

        for (let i = mfiPeriod; i < data.length; i++) {
            let positiveSum = 0;
            let negativeSum = 0;
            for (let j = 0; j < mfiPeriod; j++) {
                positiveSum += data[i - j].positiveMoneyFlow || 0;
                negativeSum += data[i - j].negativeMoneyFlow || 0;
            }
            
            if (negativeSum === 0) {
                data[i].mfi = 100;
            } else {
                const moneyRatio = positiveSum / negativeSum;
                data[i].mfi = (100 - (100 / (1 + moneyRatio))).toFixed(2);
            }
        }
        
        // Williams %R
        const wrPeriod = 14;
        for (let i = 0; i < data.length; i++) {
            if (i >= wrPeriod - 1) {
                const slice = data.slice(i - wrPeriod + 1, i + 1);
                const highestHigh = Math.max(...slice.map(d => d.high));
                const lowestLow = Math.min(...slice.map(d => d.low));
                const range = highestHigh - lowestLow;
                if (range === 0) {
                    data[i].williamsR = -50; 
                } else {
                    data[i].williamsR = (((highestHigh - data[i].close) / range) * -100).toFixed(2);
                }
            } else {
                data[i].williamsR = null;
            }
        }

        // KD
        const kdPeriod = 9;
        let lowestLows = [];
        let highestHighs = [];
        for (let i = 0; i < data.length; i++) {
            let periodData = data.slice(Math.max(0, i - kdPeriod + 1), i + 1);
            lowestLows[i] = Math.min(...periodData.map(d => d.low));
            highestHighs[i] = Math.max(...periodData.map(d => d.high));
        }

        for (let i = 0; i < data.length; i++) {
            data[i].k = null;
            data[i].d = null;
            if (i > 0) {
                 const range = highestHighs[i] - lowestLows[i];
                 const rsv = range === 0 ? 0 : ((data[i].close - lowestLows[i]) / range) * 100;
                 const prevK = data[i-1].k === null ? 50 : parseFloat(data[i-1].k);
                 data[i].k = (prevK * 2/3) + (rsv * 1/3);
                 const prevD = data[i-1].d === null ? 50 : parseFloat(data[i-1].d);
                 data[i].d = (prevD * 2/3) + (data[i].k * 1/3);
                 
                 data[i].k = data[i].k.toFixed(2);
                 data[i].d = data[i].d.toFixed(2);
            }
        }


        // MACD
        const ema = (data, period) => {
            let emaValues = [];
            if(data.length < period) return emaValues;
            let multiplier = 2 / (period + 1);
            emaValues[period - 1] = data.slice(0, period).reduce((sum, d) => sum + d.close, 0) / period;
            for (let i = period; i < data.length; i++) {
                emaValues[i] = (data[i].close - emaValues[i-1]) * multiplier + emaValues[i-1];
            }
            return emaValues;
        }
        const ema12 = ema(data, 12);
        const ema26 = ema(data, 26);
        for(let i = 0; i < data.length; i++) {
            if(ema12[i] && ema26[i]) {
                data[i].macd = (ema12[i] - ema26[i]).toFixed(2);
            } else {
                data[i].macd = null;
            }
        }
        
        const macdData = data.filter(d => d.macd !== null);
        const signalEma = ema(macdData.map(d => ({close: parseFloat(d.macd)})), 9);
        
        let signalIndex = 0;
        for(let i = 0; i < data.length; i++) {
            if(data[i].macd !== null) {
                 if (signalEma[signalIndex] !== undefined) {
                    data[i].signal = signalEma[signalIndex].toFixed(2);
                    data[i].histogram = (data[i].macd - data[i].signal).toFixed(2);
                 } else {
                    data[i].signal = null;
                    data[i].histogram = null;
                 }
                 signalIndex++;
            } else {
                 data[i].signal = null;
                 data[i].histogram = null;
            }
        }
    }

    // --- æ™ºèƒ½è­¦ç¤ºç³»çµ± ---
    
    function calculateSmartAlerts(data) {
        if (!data || data.length < 20) {
            displayAlerts([]);
            return [];
        }

        const alerts = [];
        const latest = data[data.length - 1];
        const prev = data[data.length - 2];
        const stockName = latest.stockName || '';
        const stockCode = latest.stockCode || '';
        
        // ç²å–ç”¨æˆ¶è¨­å®šçš„åƒæ•¸
        const rsiOverbought = parseFloat(document.getElementById('rsi-overbought')?.value) || 80;
        const rsiOversold = parseFloat(document.getElementById('rsi-oversold')?.value) || 20;
        const kdOverbought = parseFloat(document.getElementById('kd-overbought')?.value) || 80;
        const kdOversold = parseFloat(document.getElementById('kd-oversold')?.value) || 20;
        const volumeMultiplier = parseFloat(document.getElementById('volume-multiplier')?.value) || 2;
        const lookbackDays = parseInt(document.getElementById('lookback-days')?.value) || 20;
        
        // è¨ˆç®—å¹³å‡æˆäº¤é‡
        const recentData = data.slice(-lookbackDays);
        const avgVolume = recentData.reduce((sum, d) => sum + d.volume, 0) / recentData.length;
        
        // è¨ˆç®—æ”¯æ’èˆ‡é˜»åŠ›
        const highs = recentData.map(d => d.high);
        const lows = recentData.map(d => d.low);
        const resistance = Math.max(...highs);
        const support = Math.min(...lows);
        
        // 1. å‡ç·šé»ƒé‡‘äº¤å‰/æ­»äº¡äº¤å‰æª¢æ¸¬
        if (latest.ma5 && latest.ma20 && prev.ma5 && prev.ma20) {
            const ma5 = parseFloat(latest.ma5);
            const ma20 = parseFloat(latest.ma20);
            const prevMa5 = parseFloat(prev.ma5);
            const prevMa20 = parseFloat(prev.ma20);
            
            // é»ƒé‡‘äº¤å‰ï¼šMA5 å¾ä¸‹æ–¹ç©¿è¶Š MA20
            if (prevMa5 <= prevMa20 && ma5 > ma20) {
                alerts.push({
                    type: 'bullish',
                    icon: 'ğŸ“ˆ',
                    title: 'å‡ç·šé»ƒé‡‘äº¤å‰',
                    description: `MA5 (${ma5.toFixed(2)}) å‘ä¸Šçªç ´ MA20 (${ma20.toFixed(2)})ï¼ŒçŸ­æœŸè¶¨å‹¢è½‰å¼·ï¼Œå¯èƒ½ç‚ºè²·é€²è¨Šè™Ÿã€‚`,
                    badge: 'buy',
                    badgeText: 'è²·é€²è¨Šè™Ÿ',
                    priority: 1,
                    date: latest.date
                });
            }
            
            // æ­»äº¡äº¤å‰ï¼šMA5 å¾ä¸Šæ–¹ç©¿è¶Š MA20
            if (prevMa5 >= prevMa20 && ma5 < ma20) {
                alerts.push({
                    type: 'bearish',
                    icon: 'ğŸ“‰',
                    title: 'å‡ç·šæ­»äº¡äº¤å‰',
                    description: `MA5 (${ma5.toFixed(2)}) å‘ä¸‹è·Œç ´ MA20 (${ma20.toFixed(2)})ï¼ŒçŸ­æœŸè¶¨å‹¢è½‰å¼±ï¼Œå¯èƒ½ç‚ºè³£å‡ºè¨Šè™Ÿã€‚`,
                    badge: 'sell',
                    badgeText: 'è³£å‡ºè¨Šè™Ÿ',
                    priority: 1,
                    date: latest.date
                });
            }
            
            // å‡ç·šå¤šé ­æ’åˆ—
            if (latest.ma5 && latest.ma10 && latest.ma20) {
                const ma10 = parseFloat(latest.ma10);
                if (ma5 > ma10 && ma10 > ma20) {
                    alerts.push({
                        type: 'bullish',
                        icon: 'ğŸ”¥',
                        title: 'å‡ç·šå¤šé ­æ’åˆ—',
                        description: `MA5 > MA10 > MA20ï¼ŒçŸ­ä¸­æœŸå‡ç·šå‘ˆç¾å¤šé ­æ’åˆ—ï¼Œè¶¨å‹¢åå¤šã€‚`,
                        badge: 'buy',
                        badgeText: 'åå¤š',
                        priority: 2,
                        date: latest.date
                    });
                } else if (ma5 < ma10 && ma10 < ma20) {
                    alerts.push({
                        type: 'bearish',
                        icon: 'â„ï¸',
                        title: 'å‡ç·šç©ºé ­æ’åˆ—',
                        description: `MA5 < MA10 < MA20ï¼ŒçŸ­ä¸­æœŸå‡ç·šå‘ˆç¾ç©ºé ­æ’åˆ—ï¼Œè¶¨å‹¢åç©ºã€‚`,
                        badge: 'sell',
                        badgeText: 'åç©º',
                        priority: 2,
                        date: latest.date
                    });
                }
            }
        }
        
        // 2. çªç ´å£“åŠ›/è·Œç ´æ”¯æ’æª¢æ¸¬
        const closePrice = latest.close;
        const prevClose = prev.close;
        
        // çªç ´é˜»åŠ›
        if (closePrice > resistance * 0.995 && prevClose <= resistance * 0.995) {
            alerts.push({
                type: 'bullish',
                icon: 'ğŸš€',
                title: 'çªç ´è¿‘æœŸå£“åŠ›',
                description: `è‚¡åƒ¹ ${closePrice.toFixed(2)} çªç ´è¿‘ ${lookbackDays} æ—¥å£“åŠ›ä½ ${resistance.toFixed(2)}ï¼Œå¯èƒ½é–‹å•Ÿæ–°ä¸€æ³¢æ¼²å‹¢ã€‚`,
                badge: 'buy',
                badgeText: 'çªç ´',
                priority: 1,
                date: latest.date
            });
        }
        
        // è·Œç ´æ”¯æ’
        if (closePrice < support * 1.005 && prevClose >= support * 1.005) {
            alerts.push({
                type: 'bearish',
                icon: 'âš ï¸',
                title: 'è·Œç ´è¿‘æœŸæ”¯æ’',
                description: `è‚¡åƒ¹ ${closePrice.toFixed(2)} è·Œç ´è¿‘ ${lookbackDays} æ—¥æ”¯æ’ä½ ${support.toFixed(2)}ï¼Œéœ€æ³¨æ„ä¸‹è¡Œé¢¨éšªã€‚`,
                badge: 'sell',
                badgeText: 'è·Œç ´',
                priority: 1,
                date: latest.date
            });
        }
        
        // æ¥è¿‘å£“åŠ›ä½è­¦ç¤º
        if (closePrice >= resistance * 0.97 && closePrice < resistance) {
            alerts.push({
                type: 'warning',
                icon: 'ğŸ¯',
                title: 'æ¥è¿‘å£“åŠ›ä½',
                description: `è‚¡åƒ¹ ${closePrice.toFixed(2)} æ¥è¿‘å£“åŠ›ä½ ${resistance.toFixed(2)}ï¼ˆè·é›¢ ${((resistance - closePrice) / closePrice * 100).toFixed(1)}%ï¼‰ï¼Œç•™æ„æ˜¯å¦çªç ´æˆ–å›æª”ã€‚`,
                badge: 'watch',
                badgeText: 'è§€å¯Ÿ',
                priority: 3,
                date: latest.date
            });
        }
        
        // æ¥è¿‘æ”¯æ’ä½è­¦ç¤º
        if (closePrice <= support * 1.03 && closePrice > support) {
            alerts.push({
                type: 'warning',
                icon: 'ğŸ›¡ï¸',
                title: 'æ¥è¿‘æ”¯æ’ä½',
                description: `è‚¡åƒ¹ ${closePrice.toFixed(2)} æ¥è¿‘æ”¯æ’ä½ ${support.toFixed(2)}ï¼ˆè·é›¢ ${((closePrice - support) / closePrice * 100).toFixed(1)}%ï¼‰ï¼Œç•™æ„æ˜¯å¦æ­¢è·Œæˆ–ç ´ä½ã€‚`,
                badge: 'watch',
                badgeText: 'è§€å¯Ÿ',
                priority: 3,
                date: latest.date
            });
        }
        
        // 3. æˆäº¤é‡ç•°å¸¸æ”¾å¤§æª¢æ¸¬
        const currentVolume = latest.volume;
        const volumeRatio = currentVolume / avgVolume;
        
        if (volumeRatio >= volumeMultiplier) {
            const priceChange = ((closePrice - prev.close) / prev.close * 100).toFixed(2);
            const isUp = closePrice > prev.close;
            
            alerts.push({
                type: isUp ? 'bullish' : 'bearish',
                icon: 'ğŸ“Š',
                title: 'æˆäº¤é‡ç•°å¸¸æ”¾å¤§',
                description: `ä»Šæ—¥æˆäº¤é‡é”å¹³å‡é‡çš„ ${volumeRatio.toFixed(1)} å€ï¼Œè‚¡åƒ¹${isUp ? 'ä¸Šæ¼²' : 'ä¸‹è·Œ'} ${Math.abs(priceChange)}%ã€‚${isUp ? 'é‡å¢åƒ¹æ¼²ï¼Œå¤šæ–¹å‹•èƒ½å¼·å‹ã€‚' : 'é‡å¢åƒ¹è·Œï¼Œéœ€ç•™æ„è³£å£“ã€‚'}`,
                badge: isUp ? 'buy' : 'sell',
                badgeText: isUp ? 'é‡å¢åƒ¹æ¼²' : 'é‡å¢åƒ¹è·Œ',
                priority: 2,
                date: latest.date
            });
        }
        
        // æˆäº¤é‡èç¸®
        if (volumeRatio < 0.5) {
            alerts.push({
                type: 'neutral',
                icon: 'ğŸ“‰',
                title: 'æˆäº¤é‡èç¸®',
                description: `ä»Šæ—¥æˆäº¤é‡åƒ…ç‚ºå¹³å‡é‡çš„ ${(volumeRatio * 100).toFixed(0)}%ï¼Œå¸‚å ´è§€æœ›æ°£æ°›æ¿ƒåšã€‚`,
                badge: 'watch',
                badgeText: 'è§€å¯Ÿ',
                priority: 4,
                date: latest.date
            });
        }
        
        // 4. KD æŒ‡æ¨™è¶…è²·è¶…è³£å€æª¢æ¸¬
        if (latest.k && latest.d) {
            const k = parseFloat(latest.k);
            const d = parseFloat(latest.d);
            const prevK = prev.k ? parseFloat(prev.k) : null;
            const prevD = prev.d ? parseFloat(prev.d) : null;
            
            // KD è¶…è²·å€
            if (k > kdOverbought && d > kdOverbought) {
                alerts.push({
                    type: 'warning',
                    icon: 'ğŸ”´',
                    title: 'KD æŒ‡æ¨™è¶…è²·',
                    description: `K å€¼ ${k.toFixed(1)} èˆ‡ D å€¼ ${d.toFixed(1)} çš†é€²å…¥è¶…è²·å€ (>${kdOverbought})ï¼Œè‚¡åƒ¹å¯èƒ½é¢è‡¨å›æª”å£“åŠ›ã€‚`,
                    badge: 'sell',
                    badgeText: 'è¶…è²·',
                    priority: 2,
                    date: latest.date
                });
            }
            
            // KD è¶…è³£å€
            if (k < kdOversold && d < kdOversold) {
                alerts.push({
                    type: 'warning',
                    icon: 'ğŸŸ¢',
                    title: 'KD æŒ‡æ¨™è¶…è³£',
                    description: `K å€¼ ${k.toFixed(1)} èˆ‡ D å€¼ ${d.toFixed(1)} çš†é€²å…¥è¶…è³£å€ (<${kdOversold})ï¼Œå¯èƒ½å‡ºç¾åå½ˆå¥‘æ©Ÿã€‚`,
                    badge: 'buy',
                    badgeText: 'è¶…è³£',
                    priority: 2,
                    date: latest.date
                });
            }
            
            // KD é»ƒé‡‘äº¤å‰
            if (prevK && prevD && prevK <= prevD && k > d) {
                alerts.push({
                    type: 'bullish',
                    icon: 'âœ¨',
                    title: 'KD é»ƒé‡‘äº¤å‰',
                    description: `K å€¼ (${k.toFixed(1)}) å‘ä¸Šç©¿è¶Š D å€¼ (${d.toFixed(1)})ï¼ŒçŸ­ç·šè²·é€²è¨Šè™Ÿã€‚`,
                    badge: 'buy',
                    badgeText: 'è²·é€²',
                    priority: 2,
                    date: latest.date
                });
            }
            
            // KD æ­»äº¡äº¤å‰
            if (prevK && prevD && prevK >= prevD && k < d) {
                alerts.push({
                    type: 'bearish',
                    icon: 'ğŸ’€',
                    title: 'KD æ­»äº¡äº¤å‰',
                    description: `K å€¼ (${k.toFixed(1)}) å‘ä¸‹è·Œç ´ D å€¼ (${d.toFixed(1)})ï¼ŒçŸ­ç·šè³£å‡ºè¨Šè™Ÿã€‚`,
                    badge: 'sell',
                    badgeText: 'è³£å‡º',
                    priority: 2,
                    date: latest.date
                });
            }
        }
        
        // 5. RSI æŒ‡æ¨™è¶…è²·è¶…è³£å€æª¢æ¸¬
        if (latest.rsi) {
            const rsi = parseFloat(latest.rsi);
            const prevRsi = prev.rsi ? parseFloat(prev.rsi) : null;
            
            // RSI è¶…è²·å€
            if (rsi > rsiOverbought) {
                alerts.push({
                    type: 'warning',
                    icon: 'ğŸ”º',
                    title: 'RSI è¶…è²·è­¦ç¤º',
                    description: `RSI å€¼é” ${rsi.toFixed(1)}ï¼Œè¶…é ${rsiOverbought} é€²å…¥è¶…è²·å€ï¼Œè‚¡åƒ¹å¯èƒ½éç†±ï¼Œéœ€ç•™æ„å›æª”é¢¨éšªã€‚`,
                    badge: 'sell',
                    badgeText: 'è¶…è²·',
                    priority: 2,
                    date: latest.date
                });
            }
            
            // RSI è¶…è³£å€
            if (rsi < rsiOversold) {
                alerts.push({
                    type: 'warning',
                    icon: 'ğŸ”»',
                    title: 'RSI è¶…è³£è­¦ç¤º',
                    description: `RSI å€¼é” ${rsi.toFixed(1)}ï¼Œä½æ–¼ ${rsiOversold} é€²å…¥è¶…è³£å€ï¼Œè‚¡åƒ¹å¯èƒ½éåº¦ä¸‹è·Œï¼Œç•™æ„åå½ˆæ©Ÿæœƒã€‚`,
                    badge: 'buy',
                    badgeText: 'è¶…è³£',
                    priority: 2,
                    date: latest.date
                });
            }
            
            // RSI èƒŒé›¢æª¢æ¸¬
            if (prevRsi && data.length >= 5) {
                const fiveDaysAgo = data[data.length - 5];
                if (fiveDaysAgo.rsi) {
                    const oldRsi = parseFloat(fiveDaysAgo.rsi);
                    const oldClose = fiveDaysAgo.close;
                    
                    // é ‚èƒŒé›¢ï¼šåƒ¹æ ¼å‰µé«˜ä½† RSI æœªå‰µé«˜
                    if (closePrice > oldClose && rsi < oldRsi && rsi > 60) {
                        alerts.push({
                            type: 'warning',
                            icon: 'âš¡',
                            title: 'RSI é ‚èƒŒé›¢',
                            description: `è‚¡åƒ¹å‰µè¿‘æœŸæ–°é«˜ï¼Œä½† RSI ä¸¦æœªè·Ÿéš¨å‰µé«˜ï¼Œå¯èƒ½ç‚ºè¶¨å‹¢è½‰å¼±ä¿¡è™Ÿã€‚`,
                            badge: 'watch',
                            badgeText: 'èƒŒé›¢',
                            priority: 2,
                            date: latest.date
                        });
                    }
                    
                    // åº•èƒŒé›¢ï¼šåƒ¹æ ¼å‰µä½ä½† RSI æœªå‰µä½
                    if (closePrice < oldClose && rsi > oldRsi && rsi < 40) {
                        alerts.push({
                            type: 'warning',
                            icon: 'ğŸ’¡',
                            title: 'RSI åº•èƒŒé›¢',
                            description: `è‚¡åƒ¹å‰µè¿‘æœŸæ–°ä½ï¼Œä½† RSI ä¸¦æœªè·Ÿéš¨å‰µä½ï¼Œå¯èƒ½ç‚ºè¶¨å‹¢è½‰å¼·ä¿¡è™Ÿã€‚`,
                            badge: 'watch',
                            badgeText: 'èƒŒé›¢',
                            priority: 2,
                            date: latest.date
                        });
                    }
                }
            }
        }
        
        // 6. MACD æª¢æ¸¬
        if (latest.macd && latest.signal && prev.macd && prev.signal) {
            const macd = parseFloat(latest.macd);
            const signal = parseFloat(latest.signal);
            const prevMacd = parseFloat(prev.macd);
            const prevSignal = parseFloat(prev.signal);
            
            // MACD é»ƒé‡‘äº¤å‰
            if (prevMacd <= prevSignal && macd > signal) {
                alerts.push({
                    type: 'bullish',
                    icon: 'ğŸŒŸ',
                    title: 'MACD é»ƒé‡‘äº¤å‰',
                    description: `MACD ç·š (${macd.toFixed(2)}) å‘ä¸Šç©¿è¶Šä¿¡è™Ÿç·š (${signal.toFixed(2)})ï¼Œä¸­æœŸè¶¨å‹¢è½‰å¤šã€‚`,
                    badge: 'buy',
                    badgeText: 'è²·é€²',
                    priority: 1,
                    date: latest.date
                });
            }
            
            // MACD æ­»äº¡äº¤å‰
            if (prevMacd >= prevSignal && macd < signal) {
                alerts.push({
                    type: 'bearish',
                    icon: 'ğŸŒ‘',
                    title: 'MACD æ­»äº¡äº¤å‰',
                    description: `MACD ç·š (${macd.toFixed(2)}) å‘ä¸‹è·Œç ´ä¿¡è™Ÿç·š (${signal.toFixed(2)})ï¼Œä¸­æœŸè¶¨å‹¢è½‰ç©ºã€‚`,
                    badge: 'sell',
                    badgeText: 'è³£å‡º',
                    priority: 1,
                    date: latest.date
                });
            }
            
            // MACD æŸ±ç‹€é«”ç¿»æ­£
            if (latest.histogram && prev.histogram) {
                const hist = parseFloat(latest.histogram);
                const prevHist = parseFloat(prev.histogram);
                
                if (prevHist < 0 && hist > 0) {
                    alerts.push({
                        type: 'bullish',
                        icon: 'ğŸ“¶',
                        title: 'MACD æŸ±ç‹€é«”ç¿»æ­£',
                        description: `MACD æŸ±ç‹€é«”ç”±è² è½‰æ­£ï¼Œå‹•èƒ½é–‹å§‹è½‰å¼·ã€‚`,
                        badge: 'buy',
                        badgeText: 'è½‰å¼·',
                        priority: 3,
                        date: latest.date
                    });
                }
                
                if (prevHist > 0 && hist < 0) {
                    alerts.push({
                        type: 'bearish',
                        icon: 'ğŸ“‰',
                        title: 'MACD æŸ±ç‹€é«”ç¿»è² ',
                        description: `MACD æŸ±ç‹€é«”ç”±æ­£è½‰è² ï¼Œå‹•èƒ½é–‹å§‹è½‰å¼±ã€‚`,
                        badge: 'sell',
                        badgeText: 'è½‰å¼±',
                        priority: 3,
                        date: latest.date
                    });
                }
            }
        }
        
        // 7. å¸ƒæ—é€šé“æª¢æ¸¬
        if (latest.bb_upper && latest.bb_lower) {
            const bbUpper = parseFloat(latest.bb_upper);
            const bbLower = parseFloat(latest.bb_lower);
            
            if (closePrice >= bbUpper) {
                alerts.push({
                    type: 'warning',
                    icon: 'â¬†ï¸',
                    title: 'è§¸åŠå¸ƒæ—ä¸Šè»Œ',
                    description: `è‚¡åƒ¹ ${closePrice.toFixed(2)} è§¸åŠæˆ–çªç ´å¸ƒæ—ä¸Šè»Œ ${bbUpper.toFixed(2)}ï¼ŒçŸ­ç·šå¯èƒ½éç†±ã€‚`,
                    badge: 'watch',
                    badgeText: 'éç†±',
                    priority: 3,
                    date: latest.date
                });
            }
            
            if (closePrice <= bbLower) {
                alerts.push({
                    type: 'warning',
                    icon: 'â¬‡ï¸',
                    title: 'è§¸åŠå¸ƒæ—ä¸‹è»Œ',
                    description: `è‚¡åƒ¹ ${closePrice.toFixed(2)} è§¸åŠæˆ–è·Œç ´å¸ƒæ—ä¸‹è»Œ ${bbLower.toFixed(2)}ï¼ŒçŸ­ç·šå¯èƒ½è¶…è·Œã€‚`,
                    badge: 'watch',
                    badgeText: 'è¶…è·Œ',
                    priority: 3,
                    date: latest.date
                });
            }
        }
        
        // æŒ‰å„ªå…ˆç´šæ’åº
        alerts.sort((a, b) => a.priority - b.priority);
        
        // é¡¯ç¤ºè­¦ç¤º
        displayAlerts(alerts);
        
        return alerts;
    }
    
    function displayAlerts(alerts) {
        const container = document.getElementById('alert-container');
        const summary = document.getElementById('alert-summary');
        
        if (!alerts || alerts.length === 0) {
            container.innerHTML = `
                <div class="no-alerts">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <p>ç›®å‰æ²’æœ‰é¡¯è‘—çš„æŠ€è¡“è¨Šè™Ÿ</p>
                    <p style="font-size: 0.8rem; opacity: 0.7;">å¸‚å ´ç›¸å°å¹³ç©©ï¼Œå¯æŒçºŒè§€å¯Ÿ</p>
                </div>
            `;
            summary.style.display = 'none';
            return;
        }
        
        // è¨ˆç®—çµ±è¨ˆ
        const bullishCount = alerts.filter(a => a.type === 'bullish').length;
        const bearishCount = alerts.filter(a => a.type === 'bearish').length;
        const warningCount = alerts.filter(a => a.type === 'warning').length;
        
        // è¨ˆç®—ç¶œåˆè©•åˆ† (-100 åˆ° +100)
        let score = 0;
        alerts.forEach(alert => {
            const weight = 5 - alert.priority; // å„ªå…ˆç´šè¶Šé«˜æ¬Šé‡è¶Šå¤§
            if (alert.type === 'bullish') score += weight * 10;
            else if (alert.type === 'bearish') score -= weight * 10;
            else if (alert.badge === 'buy') score += weight * 5;
            else if (alert.badge === 'sell') score -= weight * 5;
        });
        score = Math.max(-100, Math.min(100, score)); // é™åˆ¶ç¯„åœ
        
        // æ›´æ–°çµ±è¨ˆæ‘˜è¦
        document.getElementById('bullish-count').textContent = bullishCount;
        document.getElementById('bearish-count').textContent = bearishCount;
        document.getElementById('warning-count').textContent = warningCount;
        
        const scoreEl = document.getElementById('total-score');
        scoreEl.textContent = score > 0 ? `+${score}` : score;
        scoreEl.style.color = score > 20 ? 'var(--color-rise)' : score < -20 ? 'var(--color-fall)' : 'var(--primary-color)';
        
        summary.style.display = 'grid';
        
        // ç”Ÿæˆè­¦ç¤ºåˆ—è¡¨ HTML
        let html = '';
        alerts.forEach((alert, index) => {
            html += `
                <div class="alert-item ${alert.type} ${index < 3 ? 'new' : ''}" style="animation-delay: ${index * 0.1}s">
                    <div class="alert-icon">${alert.icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">
                            ${alert.title}
                            <span class="alert-badge ${alert.badge}">${alert.badgeText}</span>
                        </div>
                        <div class="alert-description">${alert.description}</div>
                        <div class="alert-time">ğŸ“… ${alert.date}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // ç¶å®šé‡æ–°è¨ˆç®—è­¦ç¤ºæŒ‰éˆ•
    document.getElementById('refresh-alerts-btn')?.addEventListener('click', () => {
        if (originalStockData && originalStockData.length > 0) {
            calculateSmartAlerts(originalStockData);
        }
    });


    // --- 3. Charting ---
    
    function renderAllCharts(data) {
        const theme = {
            chart: { foreColor: 'var(--text-light)', background: 'transparent' },
            tooltip: { theme: 'dark' },
            xaxis: { labels: { style: { colors: 'var(--text-light)' } }, axisBorder: { color: 'var(--border-color)' }, axisTicks: { color: 'var(--border-color)' }},
            yaxis: { labels: { style: { colors: 'var(--text-light)' } }, },
            grid: { borderColor: 'var(--border-color)', strokeDashArray: 4, xaxis: { lines: { show: false } } },
        };
        
        // Main Price Chart with Bollinger Bands
        const seriesCandlestick = [{
            name: ' ', // Set an empty name to hide from legend
            type: 'candlestick',
            data: data.map(d => ({
                x: new Date(d.date).getTime(),
                y: [d.open, d.high, d.low, d.close]
            }))
        }];
        
        const seriesBBands = [
            {
                name: 'BB ä¸Šè»Œ',
                type: 'line',
                data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.bb_upper }))
            },
            {
                name: 'MA20 (ä¸­è»Œ)',
                type: 'line',
                data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.ma20 }))
            },
            {
                name: 'BB ä¸‹è»Œ',
                type: 'line',
                data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.bb_lower }))
            }
        ];
        
        renderChart('main-chart', createChartOptions('main-chart', [...seriesCandlestick, ...seriesBBands], 'candlestick', [], theme, data));
        
        // Other Indicator Charts
        const seriesRSI = [{
            name: 'RSI',
            data: data.map(d => ({
                 x: new Date(d.date).getTime(),
                 y: d.rsi
            }))
        }];
        renderChart('rsi-chart', createChartOptions('rsi-chart', seriesRSI, 'line', [30, 70], theme, data));
        
        const seriesMFI = [{
            name: 'MFI',
            data: data.map(d => ({
                 x: new Date(d.date).getTime(),
                 y: d.mfi
            }))
        }];
        renderChart('mfi-chart', createChartOptions('mfi-chart', seriesMFI, 'line', [20, 80], theme, data));

        const seriesBIAS = [{
            name: 'BIAS (6æ—¥)',
            data: data.map(d => ({
                 x: new Date(d.date).getTime(),
                 y: d.bias
            }))
        }];
        renderChart('bias-chart', createChartOptions('bias-chart', seriesBIAS, 'line', [], theme, data));
        
        const seriesWilliamsR = [{
            name: 'Williams %R',
            data: data.map(d => ({
                 x: new Date(d.date).getTime(),
                 y: d.williamsR
            }))
        }];
        renderChart('williams-r-chart', createChartOptions('williams-r-chart', seriesWilliamsR, 'line', [-80, -20], theme, data));


        const seriesMACD = [
            { name: 'DIF', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.macd })) },
            { name: 'MACD', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.signal })) },
            { name: 'OSC æŸ±', type: 'bar', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.histogram })) }
        ];
        renderChart('macd-chart', createChartOptions('macd-chart', seriesMACD, 'line', [], theme, data));

        const seriesKD = [
            { name: 'Kå€¼', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.k })) },
            { name: 'Då€¼', type: 'line', data: data.map(d => ({ x: new Date(d.date).getTime(), y: d.d })) }
        ];
        renderChart('kd-chart', createChartOptions('kd-chart', seriesKD, 'line', [20, 80], theme, data));
    }

    function renderChart(chartId, options) {
        if (charts[chartId]) {
             charts[chartId].destroy();
        }
        const chart = new ApexCharts(document.querySelector(`#${chartId}`), options);
        chart.render();
        charts[chartId] = chart;
    }

    function createChartOptions(chartId, series, type, yAxisLines = [], theme = {}, data = [], hideXAxisLabels = false) {
        const isMixed = series.some(s => s.type && s.type !== series[0].type);
        const chartType = isMixed ? 'line' : (type === 'candlestick' ? 'candlestick' : type);
        const colorRise = 'var(--color-rise)';
        const colorFall = 'var(--color-fall)';
        
        let annotations = {
             yaxis: yAxisLines.map((val, index) => ({
                y: val,
                borderColor: index === 0 ? colorFall : colorRise,
                label: {
                    borderColor: index === 0 ? colorFall : colorRise,
                    style: { color: '#2e3440', background: index === 0 ? colorFall : colorRise },
                    text: index === 0 ? `ä½æª”å€ (${yAxisLines[0]})` : `é«˜æª”å€ (${yAxisLines[1]})`
                }
            }))
        };

        if ((chartId === 'kd-chart' || chartId === 'macd-chart') && data.length >= 2) {
            const last = data[data.length - 1];
            const prev = data[data.length - 2];
            
            if(last && prev){
                const lastTimestamp = new Date(last.date).getTime();

                let signal = null; // 'buy' or 'sell'

                if (chartId === 'kd-chart' && last.k && last.d && prev.k && prev.d) {
                    if (parseFloat(last.k) > parseFloat(last.d) && parseFloat(prev.k) <= parseFloat(prev.d)) {
                        signal = 'buy';
                    } else if (parseFloat(last.k) < parseFloat(last.d) && parseFloat(prev.k) >= parseFloat(prev.d)) {
                        signal = 'sell';
                    }
                } else if (chartId === 'macd-chart' && last.macd && last.signal && prev.macd && prev.signal) {
                    if (parseFloat(last.macd) > parseFloat(last.signal) && parseFloat(prev.macd) <= parseFloat(prev.signal)) {
                        signal = 'buy';
                    } else if (parseFloat(last.macd) < parseFloat(last.signal) && parseFloat(prev.macd) >= parseFloat(prev.signal)) {
                        signal = 'sell';
                    }
                }

                if (signal) {
                    annotations.points = [{
                        x: lastTimestamp,
                        y: chartId === 'kd-chart' ? last.k : last.macd,
                        marker: {
                            size: 6,
                            fillColor: '#fff',
                            strokeColor: signal === 'buy' ? colorRise : colorFall,
                            strokeWidth: 3,
                            shape: 'circle',
                            radius: 2,
                        },
                        label: {
                            borderColor: '#4c566a',
                            borderWidth: 1,
                            borderRadius: 4,
                            offsetY: 0,
                            style: {
                                color: signal === 'buy' ? colorRise : colorFall,
                                background: '#ECEFF4',
                                fontSize: '16px', // Larger font
                                fontWeight: 600,
                                padding: { left: 8, right: 8, top: 4, bottom: 4 }
                            },
                            text: signal === 'buy' ? 'æ¼²' : 'è·Œ',
                        }
                    }];
                }
            }
        }
        
        let plotOptions = {
            candlestick: {
                colors: { upward: colorRise, downward: colorFall }
            },
            bar: {
                colors: {
                    ranges: [{ from: -Infinity, to: -0.0001, color: colorFall }, 
                             { from: 0, to: Infinity, color: colorRise }]
                },
            }
        };
        
        return {
            ...theme,
            series: series,
            annotations: annotations,
            chart: {
                ...theme.chart,
                type: chartType,
                height: 350,
                id: chartId,
                group: 'stock',
                toolbar: { show: false }, 
                zoom: { enabled: true }
            },
            xaxis: { 
                ...theme.xaxis, 
                type: 'datetime', 
                labels: { 
                    ...theme.xaxis.labels, 
                    datetimeUTC: false,
                },
                tooltip: {
                    enabled: true
                }
            },
            yaxis: {
                ...theme.yaxis,
                opposite: true, // Always move to right
                labels: { ...theme.yaxis.labels, formatter: (value) => {
                    if (value === null || typeof value === 'undefined') {
                        return '';
                    }
                    return typeof value === 'number' ? value.toLocaleString(undefined, {maximumFractionDigits: 2}) : value;
                }},
                tooltip: { enabled: true }
            },
            tooltip: {
                ...theme.tooltip,
                shared: true,
                intersect: false,
                x: { format: 'yyyy/MM/dd' },
                custom: function({ series, seriesIndex, dataPointIndex, w }) {
                    const dataPoint = data[dataPointIndex];
                    if (!dataPoint) return '';

                    const date = new Date(dataPoint.date).toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });

                    let tooltipHtml = `<div class="apexcharts-tooltip-title" style="padding: 6px 10px;">${date}</div>
                               <div class="apexcharts-tooltip-series-group" style="padding: 6px 10px; color: #FFFFFF;">`;

                    if(dataPoint.open !== undefined) {
                        const ohlc = [dataPoint.open, dataPoint.high, dataPoint.low, dataPoint.close];
                        tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>é–‹ç›¤:</span> <span style="font-weight:bold; margin-left: 10px;">${ohlc[0]}</span></div>`;
                        tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>æœ€é«˜:</span> <span style="font-weight:bold; margin-left: 10px;">${ohlc[1]}</span></div>`;
                        tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>æœ€ä½:</span> <span style="font-weight:bold; margin-left: 10px;">${ohlc[2]}</span></div>`;
                        tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>æ”¶ç›¤:</span> <span style="font-weight:bold; margin-left: 10px;">${ohlc[3]}</span></div>`;
                    }
                    if (dataPoint.volume) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>æˆäº¤é‡:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.volume.toLocaleString()}</span></div>`;
                    
                    if (dataPoint.bb_upper) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>BBä¸Šè»Œ:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.bb_upper}</span></div>`;
                    if (dataPoint.ma20) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>MA20:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.ma20}</span></div>`;
                    if (dataPoint.bb_lower) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>BBä¸‹è»Œ:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.bb_lower}</span></div>`;


                    // Indicators
                    if (dataPoint.rsi) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>RSI:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.rsi}</span></div>`;
                    if (dataPoint.mfi) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>MFI:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.mfi}</span></div>`;
                    if (dataPoint.williamsR) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>%R:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.williamsR}</span></div>`;
                    if (dataPoint.bias) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>BIAS:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.bias}</span></div>`;
                    if (dataPoint.k) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>Kå€¼:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.k}</span></div>`;
                    if (dataPoint.d) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>Då€¼:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.d}</span></div>`;
                    if (dataPoint.macd) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>DIF:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.macd}</span></div>`;
                    if (dataPoint.signal) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>MACD:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.signal}</span></div>`;
                    if (dataPoint.histogram) tooltipHtml += `<div style="display: flex; justify-content: space-between;"><span>OSC:</span> <span style="font-weight:bold; margin-left: 10px;">${dataPoint.histogram}</span></div>`;

                    tooltipHtml += `</div>`;
                    return tooltipHtml;
                }
            },
            dataLabels: { enabled: false },
            stroke: { curve: 'straight', width: [1, 1, 2, 1], dashArray: [0, 5, 0, 5] },
            plotOptions: plotOptions,
            legend: { 
                showForSingleSeries: false,
                labels: { colors: 'var(--text-light)' },
                itemMargin: { horizontal: 10, vertical: 5 }
            }
        };
    }
    
    function addDownloadButtonListeners() {
        document.querySelectorAll('.download-chart-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const chartId = e.target.dataset.chartId;
                const chart = charts[chartId];
                if (chart) {
                    // Define a complete light theme specifically for downloading clean images
                    const downloadTheme = {
                        chart: { background: '#FFFFFF', foreColor: '#333333' },
                        xaxis: { labels: { style: { colors: '#333333' } }, axisBorder: { color: '#CCCCCC' }, axisTicks: { color: '#CCCCCC' } },
                        yaxis: { labels: { style: { colors: '#333333' } } },
                        grid: { borderColor: '#E0E0E0' },
                        legend: { labels: { colors: '#333333' } },
                        tooltip: { theme: 'light' }
                    };

                    // Define the original dark theme to revert back to
                    const originalTheme = {
                        chart: { background: 'transparent', foreColor: 'var(--text-light)' },
                        xaxis: { labels: { style: { colors: 'var(--text-light)' } }, axisBorder: { color: 'var(--border-color)' }, axisTicks: { color: 'var(--border-color)' } },
                        yaxis: { labels: { style: { colors: 'var(--text-light)' } } },
                        grid: { borderColor: 'var(--border-color)' },
                        legend: { labels: { colors: 'var(--text-light)' } },
                        tooltip: { theme: 'dark' }
                    };

                    // Temporarily apply the light theme for the image export
                    await chart.updateOptions({ ...downloadTheme, animations: { enabled: false } });
                    
                    // A short delay to ensure the chart has fully re-rendered before capturing
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const { imgURI } = await chart.dataURI({ scale: 2 }); // Use scale for higher quality image
                    
                    // IMPORTANT: Revert the theme back to the original dark theme for the UI
                    await chart.updateOptions({ ...originalTheme, animations: { enabled: true } });

                    const link = document.createElement('a');
                    link.href = imgURI;
                    link.download = `${chartId}_${new Date().toISOString().slice(0,10)}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('è«‹å…ˆè¼‰å…¥è³‡æ–™ä»¥ç”Ÿæˆåœ–è¡¨ã€‚');
                }
            });
        });
    }

    // --- 4. AI Analysis & Comparison ---

    async function handleFinancialAnalysis() {
        const text = financialTextInput.value.trim();
        if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }
        if (!text) {
            alert("è«‹è²¼ä¸Šè²¡å ±æˆ–æ³•èªªæœƒæ–‡å­—å…§å®¹ã€‚");
            return;
        }

        financialAnalysisLoader.style.display = 'block';
        financialAnalysisResultContainer.style.display = 'none';
        document.getElementById('download-financial-analysis-md-btn').style.display = 'none'; // Hide
        financialAnalysisResult.innerHTML = '';

        const prompt = `ä½ æ˜¯ä¸€ä½é ‚å°–çš„è²¡å‹™åˆ†æå¸«ï¼Œè«‹é‡å°ä»¥ä¸‹æä¾›çš„å…¬å¸è²¡å ±ã€æ³•èªªæœƒé€å­—ç¨¿æˆ–æ–°èç¨¿å…§å®¹ï¼Œé€²è¡Œæ·±å…¥æ·ºå‡ºçš„åˆ†æã€‚ä½ çš„åˆ†ææ‡‰è©²åŒ…å«ï¼š
1.  **å…§å®¹æ‘˜è¦**ï¼šç”¨ 2-3 é»æ¢åˆ—å¼ï¼Œå¿«é€Ÿç¸½çµé€™ä»½è³‡æ–™çš„æ ¸å¿ƒé‡é»ã€‚
2.  **æ­£é¢è§£è®€ (Pros)**ï¼šæ ¹æ“šå…§å®¹ï¼Œæ‰¾å‡ºå°å…¬å¸æœªä¾†ç™¼å±•æœ‰åˆ©çš„å¹¾å€‹é—œéµå› ç´ ã€‚
3.  **è² é¢è§£è®€ (Cons)**ï¼šæ ¹æ“šå…§å®¹ï¼Œé»å‡ºå…¶ä¸­æ½›åœ¨çš„é¢¨éšªã€æŒ‘æˆ°æˆ–å¸‚å ´ç–‘æ…®ã€‚
4.  **ç¶œåˆè©•è«–èˆ‡å±•æœ›**ï¼šç¶œåˆä»¥ä¸Šåˆ†æï¼Œçµ¦å‡ºä½ å°å…¬å¸çŸ­æœŸï¼ˆä¸€å­£å…§ï¼‰å’Œä¸­æœŸï¼ˆåŠå¹´è‡³ä¸€å¹´ï¼‰çš„ç¶œåˆçœ‹æ³•èˆ‡å±•æœ›ã€‚

è«‹ä»¥å°ˆæ¥­ã€å®¢è§€ä¸”æ¢ç†åˆ†æ˜çš„æ–¹å¼å‘ˆç¾ä½ çš„åˆ†æå ±å‘Šã€‚

---
**å¾…åˆ†æå…§å®¹ï¼š**
${text}
---`;

        try {
            const result = await callGeminiApi(prompt);
            financialAnalysisResult.innerHTML = result.replace(/\n/g, '<br>');
            document.getElementById('download-financial-analysis-md-btn').style.display = 'inline-block'; // Show
        } catch (error) {
            financialAnalysisResult.textContent = `åˆ†æå¤±æ•—ï¼š${error.message}`;
        } finally {
            financialAnalysisResultContainer.style.display = 'flex';
            financialAnalysisLoader.style.display = 'none';
        }
    }
    
    async function handleFundamentalsAnalysis() {
         if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }
        if (originalStockData.length === 0) {
            alert("è«‹å…ˆè¼‰å…¥å€‹è‚¡è³‡æ–™ï¼Œæ‰èƒ½é€²è¡Œåˆ†æã€‚");
            return;
        }

        fundamentalsLoader.style.display = 'block';
        fundamentalsResultContainer.style.display = 'none';
        document.getElementById('download-fundamentals-md-btn').style.display = 'none'; // Hide
        fundamentalsResult.innerHTML = '';

        const stockName = originalStockData[0].stockName || '';
        const stockCode = originalStockData[0].stockCode || '';

        const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è­‰åˆ¸åˆ†æå¸«ã€‚è«‹åˆ©ç”¨ä½ çš„ç¶²è·¯æœå°‹èƒ½åŠ›ï¼Œæ‰¾å‡ºå°ç£ä¸Šå¸‚å…¬å¸ã€Œ${stockName} (${stockCode})ã€çš„æœ€æ–°åŸºæœ¬é¢è³‡æ–™ã€‚

        ä½ çš„å›è¦†æ‡‰åŒ…å«ä»¥ä¸‹é—œéµæ•¸æ“šï¼ˆå¦‚æœæ‰¾å¾—åˆ°çš„è©±ï¼‰ï¼š
        - **æœ¬ç›Šæ¯” (P/E Ratio)**
        - **è‚¡åƒ¹æ·¨å€¼æ¯” (P/B Ratio)**
        - **è‚¡æ¯æ®–åˆ©ç‡ (Dividend Yield)**
        - **æœ€æ–°ä¸€å­£çš„æ¯è‚¡ç›ˆé¤˜ (EPS)**
        - **ç¸½å¸‚å€¼**
        - **è‚¡æœ¬**

        é™¤äº†æ¢åˆ—å‡ºä»¥ä¸Šæ•¸æ“šï¼Œè«‹å†æä¾›ä¸€æ®µç°¡çŸ­çš„ã€Œ**ç¶œåˆè©•è«–**ã€ï¼Œæ ¹æ“šé€™äº›åŸºæœ¬é¢æ•¸æ“šï¼Œå°è©²å…¬å¸çš„ç›®å‰ä¼°å€¼æ°´å¹³çµ¦å‡ºä½ çš„å°ˆæ¥­çœ‹æ³•ï¼ˆä¾‹å¦‚ï¼šä¼°å€¼åé«˜ã€ä½æ–¼åˆç†å€é–“ã€æˆ–å…·å¸å¼•åŠ›ç­‰ï¼‰ã€‚

        è«‹ä»¥æ¸…æ™°ã€æ¢ç†åˆ†æ˜çš„æ–¹å¼å‘ˆç¾ä½ çš„å ±å‘Šã€‚`;

        try {
            const result = await callGroundedGeminiApi(prompt);
            fundamentalsResult.innerHTML = result.text.replace(/\n/g, '<br>');
            document.getElementById('download-fundamentals-md-btn').style.display = 'inline-block'; // Show
        } catch (error) {
            fundamentalsResult.textContent = `åˆ†æå¤±æ•—ï¼š${error.message}`;
        } finally {
            fundamentalsResultContainer.style.display = 'flex';
            fundamentalsLoader.style.display = 'none';
        }
    }

    async function handlePatternRecognition() {
        if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }
        if (originalStockData.length < 20) {
            alert("è«‹å…ˆè¼‰å…¥è¶³å¤ çš„è³‡æ–™ï¼ˆè‡³å°‘20å¤©ï¼‰ä¾†é€²è¡Œå‹æ…‹è¾¨è­˜ã€‚");
            return;
        }
        
        patternLoader.style.display = 'block';
        patternResultContainer.style.display = 'none';
        document.getElementById('download-pattern-md-btn').style.display = 'none'; // Hide
        if(charts['pattern-chart']) charts['pattern-chart'].destroy();
        
        const chartData = originalStockData.slice(-60); // Full data for rendering chart
        const aiData = chartData.map(d => ({ date: d.date, close: d.close })); // Simplified data for AI prompt

        const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£è‚¡å¸‚æŠ€è¡“åˆ†æå¸«ï¼Œå°ˆç²¾æ–¼ K ç·šå‹æ…‹è¾¨è­˜ã€‚æˆ‘å°‡æä¾›ç°¡åŒ–çš„ JSON æ ¼å¼æ¯æ—¥æ•¸æ“šï¼ˆåƒ…åŒ…å«æ—¥æœŸèˆ‡æ”¶ç›¤åƒ¹ï¼‰ï¼Œè«‹ä½ æ ¹æ“šåƒ¹æ ¼èµ°å‹¢æ¨æ–·ä¸¦è¾¨è­˜å‡ºä»¥ä¸‹å¹¾ç¨®ç¶“å…¸æŠ€è¡“å‹æ…‹ï¼šã€ŒWåº•ã€ã€ã€ŒMé ­ã€ã€ã€Œé ­è‚©åº•ã€ã€ã€Œé ­è‚©é ‚ã€ã€ã€Œä¸Šå‡ä¸‰è§’å½¢ã€ã€ã€Œä¸‹é™ä¸‰è§’å½¢ã€ã€‚
æ•¸æ“š: ${JSON.stringify(aiData)}

ä½ çš„å›è¦†å¿…é ˆã€Œåªèƒ½ã€æ˜¯ä¸€å€‹ JSON ç‰©ä»¶ï¼Œçµ•å°ä¸èƒ½æœ‰å…¶ä»–ä»»ä½•æ–‡å­—æˆ–èªªæ˜ã€‚JSON ç‰©ä»¶æ ¼å¼å¦‚ä¸‹ï¼š
{
  "analysis": "åœ¨é€™è£¡ç”¨ä¸­æ–‡ç°¡è¦ç¸½çµä½ ç™¼ç¾çš„å‹æ…‹åŠå…¶å¸‚å ´æ„ç¾©ã€‚",
  "patterns": [
    {
      "name": "å‹æ…‹ä¸­æ–‡åç¨±",
      "startDate": "YYYY-MM-DD",
      "endDate": "YYYY-MM-DD"
    }
  ]
}
ç¯„ä¾‹ï¼šå¦‚æœæ²’æœ‰ç™¼ç¾ä»»ä½•å‹æ…‹ï¼Œ"patterns" é™£åˆ—å¿…é ˆç‚ºç©ºï¼Œåƒé€™æ¨£: {"analysis": "åœ¨è¿‘æœŸæ•¸æ“šä¸­æœªç™¼ç¾æ˜é¡¯çš„ç¶“å…¸æŠ€è¡“å‹æ…‹ã€‚", "patterns": []}ã€‚
è«‹åš´æ ¼éµå®ˆæ­¤ JSON æ ¼å¼ã€‚`;

        try {
            const resultText = await callGeminiApi(prompt);
            let resultJson;
            try {
                resultJson = JSON.parse(resultText.replace(/```json/g, '').replace(/```/g, '').trim());
            } catch (parseError) {
                console.error("Failed to parse AI response as JSON:", parseError);
                console.error("Original AI response text:", resultText);
                throw new Error("AI å›æ‡‰çš„æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•è§£æã€‚");
            }


            patternResult.textContent = resultJson.analysis || "AI æœªæä¾›æ–‡å­—åˆ†æã€‚";
            document.getElementById('download-pattern-md-btn').style.display = 'inline-block'; // Show

            const annotations = resultJson.patterns.map(p => {
                let borderColor = 'var(--primary-color)'; // Default blue
                let fillColor = 'rgba(136, 192, 208, 0.2)'; // Default blue transparent

                // Bullish patterns are red, Bearish are green
                // Per user request: 'é ­è‚©åº•' (Head and Shoulders Bottom, normally bullish) is green
                const colorMap = {
                    'Wåº•': 'rise',
                    'ç´…ä¸‰å…µ': 'rise',
                    'ä¸Šå‡ä¸‰è§’å½¢': 'rise',
                    'Mé ­': 'fall',
                    'é ­è‚©åº•': 'fall', 
                    'é ­è‚©é ‚': 'fall',
                    'é»‘ä¸‰å…µ': 'fall',
                    'ä¸‹é™ä¸‰è§’å½¢': 'fall'
                };

                const type = colorMap[p.name];

                if (type === 'rise') {
                    borderColor = 'var(--color-rise)';
                    fillColor = 'rgba(191, 97, 106, 0.2)'; // Red transparent
                } else if (type === 'fall') {
                    borderColor = 'var(--color-fall)';
                    fillColor = 'rgba(163, 190, 140, 0.2)'; // Green transparent
                }

                return {
                    x: new Date(p.startDate).getTime(),
                    x2: new Date(p.endDate).getTime(),
                    fillColor: fillColor,
                    label: {
                        borderColor: borderColor,
                        style: {
                            color: '#fff',
                            background: borderColor,
                        },
                        text: p.name,
                    },
                };
            });
            
            const theme = {
                chart: { foreColor: 'var(--text-light)', background: 'transparent' },
                tooltip: { theme: 'dark' },
                xaxis: { labels: { style: { colors: 'var(--text-light)' } }, axisBorder: { color: 'var(--border-color)' }, axisTicks: { color: 'var(--border-color)' }},
                yaxis: { labels: { style: { colors: 'var(--text-light)' } }, },
                grid: { borderColor: 'var(--border-color)', strokeDashArray: 4, xaxis: { lines: { show: false } } },
            };
            
            const patternChartOptions = createChartOptions(
                'pattern-chart',
                [{
                    name: ' ',
                    type: 'candlestick',
                    data: chartData.map(d => ({
                        x: new Date(d.date).getTime(),
                        y: [d.open, d.high, d.low, d.close]
                    }))
                }],
                'candlestick',
                [],
                theme,
                chartData
            );
            patternChartOptions.annotations.xaxis = annotations;
            patternChartOptions.chart.height = 450;
            
            renderChart('pattern-chart', patternChartOptions);
            
        } catch (error) {
            console.error("AI Pattern Recognition failed:", error);
            patternResult.textContent = `å‹æ…‹è¾¨è­˜å¤±æ•—ï¼š${error.message}`;
            document.getElementById('download-pattern-md-btn').style.display = 'none'; // Hide on error
        } finally {
            patternLoader.style.display = 'none';
            patternResultContainer.style.display = 'block';
        }
    }


    async function handlePkCompare() {
        const userCodes = [
            pkStockCode1.value.trim(),
            pkStockCode2.value.trim(),
            pkStockCode3.value.trim(),
            pkStockCode4.value.trim()
        ].filter(code => code !== ''); // Get non-empty codes

        const startDate = pkStartDate.value;
        const endDate = pkEndDate.value;

        if (userCodes.length === 0 || !startDate || !endDate) {
            pkStatus.textContent = 'éŒ¯èª¤ï¼šè«‹è‡³å°‘è¼¸å…¥ä¸€å€‹è‚¡ç¥¨ä»£è™Ÿï¼Œä¸¦é¸æ“‡é–‹å§‹èˆ‡çµæŸæ—¥æœŸã€‚';
            pkStatus.style.display = 'block';
            return;
        }

        pkLoader.style.display = 'block';
        pkStatus.style.display = 'none';
        if (charts['pk-chart']) charts['pk-chart'].destroy();
        
        let codesToFetch = [...userCodes];

        try {
            // Auto-find logic
            if (userCodes.length < 4) {
                pkStatus.style.display = 'block';
                pkStatus.textContent = `æ­£åœ¨ç‚º ${userCodes[0]} æœå°‹è¿‘æœŸå¼·å‹¢çš„ç›¸é—œè‚¡ç¥¨...`;
                
                const numToFind = 4 - userCodes.length;
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£è‚¡å¸‚åˆ†æå¸«ã€‚è«‹æ‰¾å‡ºèˆ‡å°ç£ä¸Šå¸‚å…¬å¸ã€Œ${userCodes[0]}ã€åŒç”¢æ¥­æˆ–é¡Œæç›¸é—œï¼Œä¸”ã€Œè¿‘æœŸæ¼²å¹…æœ€å¤šã€çš„ ${numToFind} æ”¯è‚¡ç¥¨ã€‚è«‹åªå›è¦†è‚¡ç¥¨ä»£è™Ÿï¼Œä¸¦ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šã€Œ2303,2454,2379ã€ã€‚ä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€‚`;
                
                const result = await callGroundedGeminiApi(prompt);
                const foundCodes = result.text.replace(/\"/g, '').split(',').map(c => c.trim()).filter(c => c && !codesToFetch.includes(c));
                
                codesToFetch.push(...foundCodes.slice(0, numToFind));
                
                // Update the input fields with the found codes
                const allInputs = [pkStockCode1, pkStockCode2, pkStockCode3, pkStockCode4];
                codesToFetch.forEach((code, i) => {
                    if (allInputs[i]) {
                        allInputs[i].value = code;
                    }
                });
            }

            pkStatus.textContent = `æ­£åœ¨æŠ“å– ${codesToFetch.join(', ')} çš„è³‡æ–™...`;

            const dataPromises = codesToFetch.map(code => fetchStockData(code, startDate, endDate));
            const allData = await Promise.all(dataPromises);

            const series = allData.map((stockData, index) => {
                const code = codesToFetch[index];
                const stockName = stockData[0]?.stockName || code;
                return {
                    name: `${stockName} (${code})`,
                    data: stockData.map(d => [new Date(d.date).getTime(), d.close])
                };
            });
            
            pkStatus.style.display = 'none';

            // Chart rendering logic
            const pkTheme = {
                chart: { foreColor: 'var(--text-light)', background: 'transparent', toolbar: { show: true, tools: { download: true, selection: true, zoom: true, zoomin: true, zoomout: true, pan: true, reset: true }}},
                tooltip: { theme: 'dark', x: { format: 'yyyy/MM/dd' } },
                xaxis: { type: 'datetime', labels: { style: { colors: 'var(--text-light)' } }, axisBorder: { color: 'var(--border-color)' }, axisTicks: { color: 'var(--border-color)' }},
                yaxis: { labels: { style: { colors: 'var(--text-light)' } } },
                grid: { borderColor: 'var(--border-color)', strokeDashArray: 4 },
                legend: { labels: { colors: 'var(--text-light)' }, itemMargin: { horizontal: 10 } }
            };

            const options = {
                ...pkTheme,
                series: series,
                chart: { ...pkTheme.chart, type: 'line', height: '100%' },
                stroke: { curve: 'straight', width: 2 },
                dataLabels: { enabled: false },
            };

            const chart = new ApexCharts(pkChart, options);
            chart.render();
            charts['pk-chart'] = chart;

        } catch (error) {
            pkStatus.textContent = `æ¯”è¼ƒå¤±æ•—ï¼š${error.message}`;
            pkStatus.style.display = 'block';
        } finally {
            pkLoader.style.display = 'none';
        }
    }

    function handleBacktest() {
        if (!originalStockData || originalStockData.length < 20) {
            alert("è«‹å…ˆè¼‰å…¥è¶³å¤ çš„è³‡æ–™ï¼ˆè‡³å°‘20å¤©ï¼‰ä¾†é€²è¡Œå›æ¸¬ã€‚");
            return;
        }

        backtestLoader.style.display = 'block';
        backtestResultsContainer.style.display = 'none';
        if (charts['backtest-chart']) charts['backtest-chart'].destroy();
        
        // Use a deep copy for backtesting
        const data = JSON.parse(JSON.stringify(originalStockData));
        processStockData(data); // Ensure MAs are calculated

        const initialCapital = parseFloat(document.getElementById('initial-capital').value) || 1000000;
        let cash = initialCapital;
        let shares = 0;
        let inPosition = false;
        const trades = [];
        let currentTrade = {};
        const portfolioHistory = [];
        
        for (let i = 20; i < data.length; i++) {
            const current = data[i];
            const prev = data[i-1];
            
            const currentMA5 = parseFloat(current.ma5);
            const currentMA20 = parseFloat(current.ma20);
            const prevMA5 = parseFloat(prev.ma5);
            const prevMA20 = parseFloat(prev.ma20);

            // Buy signal: Golden Cross
            if (!inPosition && prevMA5 <= prevMA20 && currentMA5 > currentMA20) {
                const buyPrice = current.close;
                shares = Math.floor(cash / buyPrice);
                cash -= shares * buyPrice;
                inPosition = true;
                currentTrade = { buyDate: current.date, buyPrice: buyPrice };
            } 
            // Sell signal: Death Cross
            else if (inPosition && prevMA5 >= prevMA20 && currentMA5 < currentMA20) {
                const sellPrice = current.close;
                cash += shares * sellPrice;
                shares = 0;
                inPosition = false;
                currentTrade.sellDate = current.date;
                currentTrade.sellPrice = sellPrice;
                currentTrade.profit = ((sellPrice - currentTrade.buyPrice) / currentTrade.buyPrice * 100).toFixed(2);
                trades.push(currentTrade);
                currentTrade = {};
            }
            
            portfolioHistory.push({
                x: new Date(current.date).getTime(),
                y: cash + (shares * current.close)
            });
        }

        // If still in position at the end, close it
        if (inPosition) {
            const lastDay = data[data.length - 1];
            const sellPrice = lastDay.close;
            cash += shares * sellPrice;
            shares = 0;
            currentTrade.sellDate = lastDay.date;
            currentTrade.sellPrice = sellPrice;
            currentTrade.profit = ((sellPrice - currentTrade.buyPrice) / currentTrade.buyPrice * 100).toFixed(2);
            trades.push(currentTrade);
        }

        displayBacktestResults(initialCapital, portfolioHistory, trades, data);
        
        backtestLoader.style.display = 'none';
        backtestResultsContainer.style.display = 'flex';
    }

    function displayBacktestResults(initialCapital, portfolioHistory, trades, data) {
        const finalValue = portfolioHistory.length > 0 ? portfolioHistory[portfolioHistory.length - 1].y : initialCapital;
        const totalReturn = ((finalValue - initialCapital) / initialCapital * 100).toFixed(2);
        const winningTrades = trades.filter(t => t.profit > 0).length;
        const winRate = trades.length > 0 ? (winningTrades / trades.length * 100).toFixed(2) : 0;

        backtestSummaryCards.innerHTML = `
            <div class="summary-item">
                <h4>æœ€çµ‚è³‡ç”¢</h4>
                <p>${Math.round(finalValue).toLocaleString()}</p>
            </div>
            <div class="summary-item">
                <h4>ç¸½å ±é…¬ç‡</h4>
                <p class="${totalReturn >= 0 ? 'text-rise' : 'text-fall'}">${totalReturn}%</p>
            </div>
            <div class="summary-item">
                <h4>äº¤æ˜“æ¬¡æ•¸</h4>
                <p>${trades.length}</p>
            </div>
            <div class="summary-item">
                <h4>å‹ç‡</h4>
                <p>${winRate}%</p>
            </div>
        `;

        backtestTradesBody.innerHTML = '';
        trades.forEach(trade => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${trade.buyDate}</td>
                <td>${trade.buyPrice}</td>
                <td>${trade.sellDate}</td>
                <td>${trade.sellPrice}</td>
                <td class="${trade.profit >= 0 ? 'text-rise' : 'text-fall'}">${trade.profit}%</td>
            `;
            backtestTradesBody.appendChild(row);
        });
        
        // Buy and Hold strategy
        const buyAndHoldShares = Math.floor(initialCapital / data[19].close);
        const buyAndHoldHistory = data.slice(19).map(d => ({
            x: new Date(d.date).getTime(),
            y: (buyAndHoldShares * d.close) + (initialCapital - buyAndHoldShares * data[19].close)
        }));

        const backtestTheme = {
            chart: { foreColor: 'var(--text-light)', background: 'transparent' },
            tooltip: { theme: 'dark', x: { format: 'yyyy/MM/dd' } },
            xaxis: { type: 'datetime', labels: { style: { colors: 'var(--text-light)' } } },
            yaxis: { labels: { formatter: (val) => {
                if (val === null || typeof val === 'undefined') {
                    return '';
                }
                return typeof val === 'number' ? val.toLocaleString(undefined, {maximumFractionDigits: 0}) : val;
            }, style: { colors: 'var(--text-light)' } } },
            grid: { borderColor: 'var(--border-color)', strokeDashArray: 4 },
            legend: { labels: { colors: 'var(--text-light)' } }
        };

        const options = {
            ...backtestTheme,
            series: [{
                name: 'ç­–ç•¥å ±é…¬',
                data: portfolioHistory
            }, {
                name: 'è²·å…¥ä¸¦æŒæœ‰',
                data: buyAndHoldHistory
            }],
            chart: { ...backtestTheme.chart, type: 'line', height: 300 },
            stroke: { curve: 'straight', width: 2 },
            dataLabels: { enabled: false },
        };
        
        const chart = new ApexCharts(document.querySelector("#backtest-chart"), options);
        chart.render();
        charts['backtest-chart'] = chart;
    }


    async function handleAnalysis() {
        if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }
        if (originalStockData.length === 0) {
            aiResultContainer.style.display = 'block';
            aiResultDiv.textContent = 'è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™ã€‚';
            return;
        }

        aiLoader.style.display = 'block';
        aiResultContainer.style.display = 'none';
        aiResultDiv.textContent = '';
        ttsBtn.style.display = 'none';
        document.getElementById('download-ai-result-md-btn').style.display = 'none';

        const analysisType = document.getElementById('analysis-type').value;
        const recentData = originalStockData.slice(-30);
        const prompt = generatePrompt(analysisType, recentData);

        try {
            const result = await callGeminiApi(prompt);
            aiResultDiv.textContent = result;
            ttsBtn.style.display = 'block';
            document.getElementById('download-ai-result-md-btn').style.display = 'inline-block'; // Show button
        } catch (error) {
            console.error('AI analysis failed:', error);
            aiResultDiv.textContent = `åˆ†æå¤±æ•—ï¼š${error.message}`;
        } finally {
            aiResultContainer.style.display = 'block';
            aiLoader.style.display = 'none';
        }
    }

    async function handleWebQa() {
        const question = qaInput.value.trim();
        if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }
        if (originalStockData.length === 0) {
            alert("è«‹å…ˆè¼‰å…¥å€‹è‚¡è³‡æ–™ï¼Œæ‰èƒ½é€²è¡Œç›¸é—œæå•ã€‚");
            return;
        }
        if (!question) {
            alert("è«‹è¼¸å…¥æ‚¨çš„å•é¡Œã€‚");
            return;
        }

        qaLoader.style.display = 'block';
        qaResultContainer.style.display = 'none';
        document.getElementById('download-qa-result-md-btn').style.display = 'none'; // Hide
        qaResult.textContent = '';
        qaCitations.innerHTML = '';
        
        const stockName = originalStockData[0].stockName || '';
        const stockCode = originalStockData[0].stockCode || '';
        const fullPrompt = `è«‹æ ¹æ“šç¶²è·¯ä¸Šçš„æœ€æ–°è³‡è¨Šï¼Œå›ç­”é—œæ–¼å°ç£ä¸Šå¸‚å…¬å¸ã€Œ${stockName} (${stockCode})ã€çš„ä»¥ä¸‹å•é¡Œï¼š${question}`;
        
        try {
            const result = await callGroundedGeminiApi(fullPrompt);
            qaResult.textContent = result.text;
            document.getElementById('download-qa-result-md-btn').style.display = 'block'; // Show button
            if (result.sources && result.sources.length > 0) {
                let citationsHtml = '<h4>åƒè€ƒä¾†æºï¼š</h4>';
                result.sources.forEach(source => {
                    citationsHtml += `<a href="${source.uri}" target="_blank" rel="noopener noreferrer">${source.title}</a>`;
                });
                qaCitations.innerHTML = citationsHtml;
            }
        } catch (error) {
            qaResult.textContent = `ç¶²è·¯å•ç­”å¤±æ•—ï¼š${error.message}`;
            document.getElementById('download-qa-result-md-btn').style.display = 'none'; // Hide on error
        } finally {
            qaResultContainer.style.display = 'block';
            qaLoader.style.display = 'none';
        }
    }
    
    async function handleExpertAdvice() {
        if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }
        if (originalStockData.length === 0) {
            expertAdviceResult.textContent = 'è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™ã€‚';
            return;
        }

        expertAdviceLoader.style.display = 'block';
        expertAdviceResultContainer.style.display = 'none';
        expertAdviceResult.textContent = '';
        generateExpertAdviceBtn.disabled = true;
        
        downloadPdfBtn.disabled = true;
        downloadPdfBtn.style.opacity = '0.5';
        downloadPdfBtn.style.cursor = 'not-allowed';
        
        const expertAdviceMdBtn = document.getElementById('download-expert-advice-md-btn'); // Get button
        expertAdviceMdBtn.disabled = true; // Disable
        expertAdviceMdBtn.style.opacity = '0.5';
        expertAdviceMdBtn.style.cursor = 'not-allowed';


        try {
            const stockName = originalStockData[0].stockName || '';
            const stockCode = originalStockData[0].stockCode || '';
            const prompt = `ä½ æ˜¯ä¸€ä½é ‚å°–çš„å°ç£è‚¡å¸‚é‡‘èåˆ†æå¸«ã€‚è«‹æ ¹æ“šæˆ‘æä¾›çš„é€™æª”è‚¡ç¥¨ã€Œ${stockName} (${stockCode})ã€çš„æ­·å²æ•¸æ“šï¼Œä¸¦åˆ©ç”¨ä½ çš„ç¶²è·¯æœå°‹èƒ½åŠ›æŸ¥æ‰¾æœ€æ–°çš„å¸‚å ´ç‹€æ³ã€æ–°èå’Œç›¸é—œè³‡è¨Šï¼Œä¾†æ¨æ–·ä¸¦é æ¸¬è©²è‚¡ç¥¨åœ¨ã€Œæœªä¾†ä¸€æ—¥åˆ°ä¸€é€±å…§ã€ã®å¯èƒ½èµ°å‹¢ã€‚

ä½ çš„åˆ†ææ‡‰åŒ…å«ï¼š
1.  **è¶¨å‹¢åˆ¤æ–·**ï¼šæ˜ç¢ºæŒ‡å‡ºä½ å°å¾Œå‹¢çš„çœ‹æ³•ï¼ˆä¾‹å¦‚ï¼šåå¤šæ•´ç†ã€ç›¤æ•´å¾…è®Šã€åç©ºçœ‹å¾…ã€å¯èƒ½å‡ºç¾åå½ˆç­‰ï¼‰ã€‚
2.  **åˆ†æä¾æ“š**ï¼šç°¡è¦èªªæ˜ä½ çš„åˆ¤æ–·æ˜¯åŸºæ–¼å“ªäº›å› ç´ ï¼Œä¾‹å¦‚ï¼š
    -   **æŠ€è¡“é¢**ï¼šç›®å‰çš„ K ç·šå‹æ…‹ã€æŒ‡æ¨™è¨Šè™Ÿï¼ˆKDã€MACDç­‰ï¼‰é€éœ²ä»€éº¼è¨Šæ¯ï¼Ÿ
    -   **å¸‚å ´æƒ…ç·’/æ¶ˆæ¯é¢**ï¼šæœ€è¿‘æ˜¯å¦æœ‰ä»»ä½•å¯èƒ½å½±éŸ¿è‚¡åƒ¹çš„é‡å¤§æ–°èã€è²¡å ±ã€æ³•èªªæœƒæˆ–ç”¢æ¥­å‹•æ…‹ï¼Ÿ
3.  **é—œéµåƒ¹ä½**ï¼šæå‡ºè¿‘æœŸä¸Šæª”çš„å£“åŠ›å€å’Œä¸‹æª”çš„æ”¯æ’å€åœ¨å“ªè£¡ã€‚

è«‹ä»¥å°ˆæ¥­ã€å®¢è§€ä¸”æ¢ç†åˆ†æ˜çš„æ–¹å¼å‘ˆç¾ä½ çš„åˆ†æå ±å‘Šã€‚`;
            
            const result = await callGroundedGeminiApi(prompt);
            expertAdviceResult.innerHTML = result.text.replace(/\n/g, '<br>'); // Keep formatting
            
            downloadPdfBtn.disabled = false;
            downloadPdfBtn.style.opacity = '1';
            downloadPdfBtn.style.cursor = 'pointer';
            
            expertAdviceMdBtn.disabled = false; // Enable MD button
            expertAdviceMdBtn.style.opacity = '1';
            expertAdviceMdBtn.style.cursor = 'pointer';
            
        } catch (error) {
            console.error('AI expert advice failed:', error);
            expertAdviceResult.textContent = `AI å°ˆå®¶å»ºè­°ç”Ÿæˆå¤±è´¥ï¼š${error.message}`;
        } finally {
            expertAdviceLoader.style.display = 'none';
            expertAdviceResultContainer.style.display = 'flex'; // Use flex to enable scrolling
            generateExpertAdviceBtn.disabled = false;
        }
    }

    async function handleTrumpQuoteAnalysis() {
        let quote = trumpQuoteInput.value.trim();
        if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }
        if (originalStockData.length === 0) {
            alert("è«‹å…ˆè¼‰å…¥å€‹è‚¡è³‡æ–™ï¼Œæ‰èƒ½é€²è¡Œç›¸é—œæ¦‚å¿µè‚¡åˆ†æã€‚");
            return;
        }

        trumpLoader.style.display = 'block';
        trumpResultContainer.style.display = 'none';
        document.getElementById('download-trump-result-md-btn').style.display = 'none'; // Hide
        trumpResult.innerHTML = '';
        
        const stockName = originalStockData[0].stockName || 'é€™æ”¯è‚¡ç¥¨';
        const stockCode = originalStockData[0].stockCode || '';
        
        let prompt;

        if (quote) {
            prompt = `ä½ æ˜¯ä¸€ä½é ‚å°–çš„é‡‘èå¸‚å ´åˆ†æå¸«ï¼Œå°ˆé•·æ˜¯åˆ†æåœ‹éš›æ”¿æ²»äººç‰©è¨€è«–å°å…¨çƒå¸‚å ´çš„å½±éŸ¿ã€‚
è«‹é‡å°ç¾åœ‹å‰ç¸½çµ±å·æ™®çš„é€™å¥è©±ï¼šã€Œ${quote}ã€ï¼Œé€²è¡Œæ·±å…¥åˆ†æï¼š
1.  **å…¨çƒå¸‚å ´å½±éŸ¿**ï¼šé€™å¥è©±å¯èƒ½å°æ­ç¾è‚¡å¸‚å’Œå°ç£è‚¡å¸‚é€ æˆä»€éº¼æ¨£çš„çŸ­æœŸæˆ–é•·æœŸå½±éŸ¿ï¼Ÿè«‹èªªæ˜ä½ çš„æ¨è«–ä¾æ“šã€‚
2.  **æ¦‚å¿µè‚¡é—œè¯åˆ†æ**ï¼šç›®å‰æˆ‘å€‘æ­£åœ¨åˆ†æçš„è‚¡ç¥¨æ˜¯ã€Œ${stockName} (${stockCode})ã€ã€‚è«‹åˆ©ç”¨ç¶²è·¯æœå°‹ï¼Œæ‰¾å‡ºèˆ‡é€™æ”¯è‚¡ç¥¨ç›´æ¥ç›¸é—œçš„ç”¢æ¥­æˆ–æ¦‚å¿µè‚¡ã€‚
3.  **å€‹è‚¡å½±éŸ¿æ¨è«–**ï¼šåŸºæ–¼ä½ å°å·æ™®è©±èªçš„è§£è®€ï¼Œé€™å¥è©±æ˜¯å¦æœƒå°ä¸Šè¿°æ‰¾å‡ºçš„ç›¸é—œæ¦‚å¿µè‚¡ç”¢ç”Ÿæ­£é¢æˆ–è² é¢çš„å½±éŸ¿ï¼Ÿè«‹è©³ç´°è§£æã€‚
è«‹ä»¥æ¢ç†åˆ†æ˜ã€å°ˆæ¥­å®¢è§€çš„æ–¹å¼å‘ˆç¾ä½ çš„åˆ†æå ±å‘Šã€‚`;
        } else {
            prompt = `ä½ æ˜¯ä¸€ä½é ‚å°–çš„é‡‘èå¸‚å ´åˆ†æå¸«ï¼Œå°ˆé•·æ˜¯åˆ†æåœ‹éš›æ”¿æ²»äººç‰©è¨€è«–å°å…¨çƒå¸‚å ´çš„å½±éŸ¿ã€‚
è«‹å…ˆåˆ©ç”¨ä½ çš„ç¶²è·¯æœå°‹èƒ½åŠ›ï¼Œæ‰¾å‡ºã€Œæœ€è¿‘å¹¾å¤©ã€ç¾åœ‹å‰ç¸½çµ±å·æ™®ç™¼è¡¨éçš„ä¸€å¥ã€Œå°å¸‚å ´æœ€å…·å½±éŸ¿åŠ›ã€çš„è©±ã€‚

ç„¶å¾Œï¼Œè«‹é‡å°ä½ æ‰¾åˆ°çš„é€™å¥è©±ï¼Œé€²è¡Œæ·±å…¥åˆ†æï¼š
1.  **å¼•è¿°åŸæ–‡**ï¼šé¦–å…ˆï¼Œè«‹æ˜ç¢ºå¼•è¿°ä½ æ‰¾åˆ°çš„é‚£å¥å·æ™®çš„è©±ã€‚
2.  **å…¨çƒå¸‚å ´å½±éŸ¿**ï¼šé€™å¥è©±å¯èƒ½å°æ­ç¾è‚¡å¸‚å’Œå°ç£è‚¡å¸‚é€ æˆä»€éº¼æ¨£çš„çŸ­æœŸæˆ–é•·æœŸå½±éŸ¿ï¼Ÿè«‹èªªæ˜ä½ çš„æ¨è«–ä¾æ“šã€‚
3.  **æ¦‚å¿µè‚¡é—œè¯åˆ†æ**ï¼šç›®å‰æˆ‘å€‘æ­£åœ¨åˆ†æçš„è‚¡ç¥¨æ˜¯ã€Œ${stockName} (${stockCode})ã€ã€‚è«‹åˆ©ç”¨ç¶²è·¯æœå°‹ï¼Œæ‰¾å‡ºèˆ‡é€™æ”¯è‚¡ç¥¨ç›´æ¥ç›¸é—œçš„ç”¢æ¥­æˆ–æ¦‚å¿µè‚¡ã€‚
4.  **å€‹è‚¡å½±éŸ¿æ¨è«–**ï¼šåŸºæ–¼ä½ å°å·æ™®è©±èªçš„è§£è®€ï¼Œé€™å¥è©±æ˜¯å¦æœƒå°ä¸Šè¿°æ‰¾å‡ºçš„ç›¸é—œæ¦‚å¿µè‚¡ç”¢ç”Ÿæ­£é¢æˆ–è² é¢çš„å½±éŸ¿ï¼Ÿè«‹è©³ç´°è§£æã€‚
è«‹ä»¥æ¢ç†åˆ†æ˜ã€å°ˆæ¥­å®¢è§€çš„æ–¹å¼å‘ˆç¾ä½ çš„åˆ†æå ±å‘Šã€‚`;
        }

        try {
            const result = await callGroundedGeminiApi(prompt);
            trumpResult.innerHTML = result.text.replace(/\n/g, '<br>');
            document.getElementById('download-trump-result-md-btn').style.display = 'inline-block'; // Show
        } catch (error) {
            trumpResult.textContent = `åˆ†æå¤±æ•—ï¼š${error.message}`;
        } finally {
            trumpResultContainer.style.display = 'flex';
            trumpLoader.style.display = 'none';
        }
    }
    
    async function handleUsMarketAnalysis() {
         if (!userApiKey) {
            alert("è«‹å…ˆåœ¨ AI åˆ†æå€å¡Šè¨­å®šä¸¦é©—è­‰æ‚¨çš„ Gemini API é‡‘é‘°ã€‚");
            return;
        }

        usMarketLoader.style.display = 'block';
        usMarketResultContainer.style.display = 'none';
        document.getElementById('download-us-market-md-btn').style.display = 'none'; // Hide
        usMarketResult.innerHTML = '';

        const stockName = originalStockData.length > 0 ? originalStockData[0].stockName : 'å°è‚¡';
        const stockCode = originalStockData.length > 0 ? originalStockData[0].stockCode : '';

        const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è¯çˆ¾è¡—é‡‘èåˆ†æå¸«ã€‚è«‹åˆ©ç”¨ä½ çš„ç¶²è·¯æœå°‹èƒ½åŠ›ï¼ŒæŠ“å–ã€Œæœ€æ–°ä¸€å€‹äº¤æ˜“æ—¥ã€çš„ç¾è‚¡æ”¶ç›¤æ•¸æ“šï¼Œä¸¦é‡å°ä»¥ä¸‹ä¸‰å¤§æŒ‡æ•¸æä¾›ä¸€ä»½å®Œæ•´çš„ç›¤å¾Œåˆ†æå ±å‘Šï¼š
1.  **è²»åŸåŠå°é«”æŒ‡æ•¸ (SOX)**
2.  **S&P 500 æŒ‡æ•¸ (SPX)**
3.  **é“ç“Šå·¥æ¥­æŒ‡æ•¸ (DJI)**

ä½ çš„åˆ†æå ±å‘Šæ‡‰åŒ…å«ï¼š
-   **æ•¸æ“šç¸½è¦½**ï¼šæ¢åˆ—å‡ºé€™ä¸‰å¤§æŒ‡æ•¸çš„æœ€æ–°æ”¶ç›¤é»ä½ã€æ¼²è·Œé»æ•¸ã€ä»¥åŠæ¼²è·Œå¹… (%)ã€‚
-   **å¸‚å ´è©•è«–**ï¼šæä¾›ä¸€æ®µç¶œåˆè©•è«–ï¼Œèªªæ˜å½±éŸ¿ç•¶å¤©ç¾è‚¡èµ°å‹¢çš„ä¸»è¦åŸå› ï¼ˆä¾‹å¦‚ï¼šç¶“æ¿Ÿæ•¸æ“šã€è¯æº–æœƒ(FED)æ”¿ç­–ã€é‡è¦è²¡å ±ã€åœ‹éš›æƒ…å‹¢ç­‰ï¼‰ã€‚
-   **å°å°è‚¡å½±éŸ¿**ï¼šåŸºæ–¼ä»Šå¤©çš„èµ°å‹¢ï¼Œç‰¹åˆ¥æ˜¯è²»åŸåŠå°é«”æŒ‡æ•¸çš„è¡¨ç¾ï¼Œç°¡è¦åˆ†æé€™å°æ˜å¤©å°è‚¡é–‹ç›¤ï¼ˆå°¤å…¶æ˜¯èˆ‡ ${stockName} ${stockCode} ç›¸é—œçš„é›»å­è‚¡èˆ‡åŠå°é«”é¡è‚¡ï¼‰å¯èƒ½å¸¶ä¾†çš„æ½›åœ¨å½±éŸ¿ã€‚

è«‹ä»¥æ¸…æ™°ã€æ¢ç†åˆ†æ˜çš„æ–¹å¼å‘ˆç¾ä½ çš„å ±å‘Šã€‚`;

        try {
            const result = await callGroundedGeminiApi(prompt);
            let formattedText = result.text.replace(/\n/g, '<br>');

            // Add color for bullish terms and positive numbers
            formattedText = formattedText.replace(/(\+[\d\.,]+%?|\(æ¼²|\(ä¸Šæ¼²|ä¸Šæ¼²|èµ°é«˜|æ”¶é«˜|å¤§æ¼²|å¼·å½ˆ|æ”¶æ¼²|ä¸Šæš|åˆ©å¤š|çœ‹æ¼²)/g, '<span class="text-rise">$1</span>');

            // Add color for bearish terms and negative numbers
            formattedText = formattedText.replace(/(\-[\d\.,]+%?|\(è·Œ|\(ä¸‹è·Œ|ä¸‹è·Œ|èµ°ä½|æ”¶ä½|å¤§è·Œ|é‡æŒ«|ä¸‹æŒ«|æ”¶é»‘|ä¸‹æ®º|æ”¶è·Œ|åˆ©ç©º|çœ‹è·Œ)/g, '<span class="text-fall">$1</span>');

            usMarketResult.innerHTML = formattedText;
            document.getElementById('download-us-market-md-btn').style.display = 'inline-block'; // Show
        } catch (error) {
            usMarketResult.textContent = `ç¾è‚¡åˆ†æå¤±æ•—ï¼š${error.message}`;
        } finally {
            usMarketResultContainer.style.display = 'flex';
            usMarketLoader.style.display = 'none';
        }
    }


    function generatePrompt(type, data) {
        const stockInfo = (data && data.length > 0) ? `${data[0].stockName} (${data[0].stockCode})` : "é€™æ”¯è‚¡ç¥¨";
        const dataSample = JSON.stringify(data.map(d => ({ date: d.date, open: d.open, high: d.high, low: d.low, close: d.close, volume: d.volume, rsi: d.rsi, macd: d.macd })), null, 2);
        let prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£è‚¡å¸‚é‡‘èåˆ†æå¸«ï¼Œè«‹æ ¹æ“šä»¥ä¸‹ ${stockInfo} æœ€è¿‘30å¤©çš„è‚¡ç¥¨æ•¸æ“šï¼Œæä¾›åˆ†æã€‚\næ•¸æ“šç¯„ä¾‹:\n${dataSample}\n\n`;
        switch (type) {
            case 'summary':
                prompt += "è«‹æä¾›ä¸€å€‹ç¸½é«”æ‘˜è¦ï¼ŒåŒ…æ‹¬åƒ¹æ ¼è¶¨å‹¢ã€æˆäº¤é‡è®ŠåŒ–å’Œé—œéµæ”¯æ’/å£“åŠ›ä½ã€‚";
                break;
            case 'technical':
                prompt += "è«‹æ·±å…¥åˆ†ææŠ€è¡“æŒ‡æ¨™ï¼ŒåŒ…æ‹¬ç§»å‹•å¹³å‡ç·š(MA)ã€ç›¸å°å¼·å¼±æŒ‡æ•¸(RSI)ã€ä¹–é›¢ç‡(BIAS)ã€éš¨æ©ŸæŒ‡æ¨™(KD)å’ŒMACDï¼Œä¸¦è§£é‡‹å®ƒå€‘æ‰€å‚³é”çš„å¸‚å ´ä¿¡è™Ÿã€‚";
                break;
            case 'fundamental':
                prompt += "é›–ç„¶æ²’æœ‰æä¾›å®Œæ•´çš„è²¡å‹™å ±è¡¨ï¼Œä½†è«‹æ ¹æ“šåƒ¹æ ¼è¡Œç‚ºå’Œæˆäº¤é‡æ¨æ–·å¯èƒ½çš„å¸‚å ´æƒ…ç·’å’ŒåŸºæœ¬é¢é æœŸã€‚";
                break;
            case 'news':
                prompt += "è«‹æ¨¡æ“¬åˆ†æï¼Œå‡è¨­è¿‘æœŸæœ‰é‡å¤§å¸‚å ´æ–°èï¼ˆä¾‹å¦‚è²¡å ±ã€ç”¢æ¥­æ”¿ç­–ï¼‰ï¼Œé€™äº›æ•¸æ“šå¦‚ä½•åæ˜ å¸‚å ´å°æ–°èçš„åæ‡‰ï¼Ÿ";
                break;
            case 'future':
                prompt += "æ ¹æ“šç›®å‰çš„æŠ€è¡“æŒ‡æ¨™å’Œåƒ¹æ ¼è¶¨å‹¢ï¼Œè«‹æä¾›å°æœªä¾†çŸ­æœŸï¼ˆä¸€é€±å…§ï¼‰èµ°å‹¢çš„é æ¸¬å’Œå¯èƒ½çš„æƒ…å¢ƒåˆ†æã€‚";
                break;
        }
        return prompt + "\n\nè«‹ä»¥å°ˆæ¥­ã€ç°¡æ½”ã€æ¢åˆ—å¼çš„æ–¹å¼å‘ˆç¾åˆ†æçµæœã€‚";
    }

    async function callGeminiApi(prompt) {
        if (!userApiKey) {
            throw new Error("å°šæœªè¨­å®š Gemini API é‡‘é‘°ï¼Œè«‹åœ¨ AI åˆ†æå€å¡Šä¸­è¼¸å…¥ä¸¦å„²å­˜ã€‚");
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${userApiKey}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            // Lower temperature for more consistent JSON output
            generationConfig: { temperature: 0.2, topK: 1, topP: 1, maxOutputTokens: 8192 },
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            console.error("API Error Response:", errorBody);
            throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
        }
        
        const result = await response.json();

        // Enhanced error checking
        if (!result.candidates || result.candidates.length === 0) {
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                 throw new Error(`è«‹æ±‚å› ã€Œ${result.promptFeedback.blockReason}ã€è€Œè¢«å®‰å…¨æ©Ÿåˆ¶å°é–ã€‚`);
            }
            console.error("ç„¡æ•ˆçš„ Gemini API å›æ‡‰ (æ²’æœ‰å€™é¸ç­”æ¡ˆ):", JSON.stringify(result, null, 2));
            throw new Error('API å›æ‡‰ç„¡æ•ˆï¼ŒæœªåŒ…å«ä»»ä½•å€™é¸å…§å®¹ã€‚');
        }

        const candidate = result.candidates[0];

        // Check for finish reason other than STOP
        if (candidate.finishReason && candidate.finishReason !== 'STOP') {
             console.error("API å›æ‡‰æå‰çµ‚æ­¢:", JSON.stringify(result, null, 2));
             throw new Error(`API å›æ‡‰å› ã€Œ${candidate.finishReason}ã€è€Œæå‰çµ‚æ­¢ï¼Œå¯èƒ½æ˜¯å› ç‚ºå…§å®¹éé•·æˆ–å®‰å…¨è¨­å®šã€‚`);
        }

        if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
            return candidate.content.parts[0].text;
        } else {
            // This case handles when the response is blocked for safety.
            console.error("ç„¡æ•ˆçš„ Gemini API å›æ‡‰ (å¯èƒ½è¢«å®‰å…¨è¨­å®šé˜»æ“‹):", JSON.stringify(result, null, 2));
            throw new Error('API å›æ‡‰ä¸­æœªåŒ…å«æœ‰æ•ˆçš„å…§å®¹ (å¯èƒ½å·²è¢«å®‰å…¨è¨­å®šé˜»æ“‹)ã€‚');
        }
    }

    async function callGroundedGeminiApi(prompt) {
        if (!userApiKey) {
            throw new Error("å°šæœªè¨­å®š Gemini API é‡‘é‘°ï¼Œè«‹åœ¨ AI åˆ†æå€å¡Šä¸­è¼¸å…¥ä¸¦å„²å­˜ã€‚");
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${userApiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            tools: [{ "google_search": {} }],
            generationConfig: { temperature: 0.2, topK: 1, topP: 1, maxOutputTokens: 8192 },
        };
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            throw new Error(`ç¶²è·¯å•ç­” API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
        }
        const result = await response.json();
        const candidate = result.candidates?.[0];

        if (candidate && candidate.content?.parts?.[0]?.text) {
            const text = candidate.content.parts[0].text;
            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);
            }
            return { text, sources };
        } else {
            console.error("ç„¡æ•ˆçš„ç¶²è·¯å•ç­” API å›æ‡‰:", JSON.stringify(result, null, 2));
            throw new Error('ç¶²è·¯å•ç­” API å›æ‡‰ä¸­æœªåŒ…å«æœ‰æ•ˆçš„å…§å®¹ã€‚');
        }
    }

    // --- ç±Œç¢¼åˆ†æåŠŸèƒ½ ---
    
    const chipLoader = document.getElementById('chip-loader');
    const chipAnalysisResult = document.getElementById('chip-analysis-result');
    const chipPlaceholder = document.getElementById('chip-placeholder');
    const fetchChipDataBtn = document.getElementById('fetch-chip-data-btn');
    const aiChipAnalysisBtn = document.getElementById('ai-chip-analysis-btn');
    
    // CORS Proxy åˆ—è¡¨ï¼ˆä¾åºå˜—è©¦ï¼‰
    const corsProxies = [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest='
    ];
    
    let currentChipData = null;
    
    // å˜—è©¦ä½¿ç”¨ CORS Proxy ç²å–è³‡æ–™
    async function fetchWithProxy(url) {
        for (const proxy of corsProxies) {
            try {
                const response = await fetch(proxy + encodeURIComponent(url), {
                    timeout: 10000
                });
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.log(`Proxy ${proxy} failed, trying next...`);
            }
        }
        throw new Error('æ‰€æœ‰ Proxy éƒ½ç„¡æ³•é€£æ¥');
    }
    
    // ç²å–ä¸‰å¤§æ³•äººè²·è³£è¶…è³‡æ–™
    async function fetchInstitutionalData(stockCode, date) {
        const dateStr = date.replace(/-/g, '');
        const url = `https://www.twse.com.tw/rwd/zh/fund/T86?date=${dateStr}&selectType=ALLBUT0999&response=json`;
        
        try {
            const data = await fetchWithProxy(url);
            if (data && data.data) {
                // æœå°‹ç‰¹å®šè‚¡ç¥¨
                const stockData = data.data.find(row => row[0] === stockCode);
                if (stockData) {
                    return {
                        date: data.date,
                        stockCode: stockData[0],
                        stockName: stockData[1],
                        foreignBuy: parseInt(stockData[2].replace(/,/g, '')) || 0,
                        foreignSell: parseInt(stockData[3].replace(/,/g, '')) || 0,
                        foreignNet: parseInt(stockData[4].replace(/,/g, '')) || 0,
                        trustBuy: parseInt(stockData[5].replace(/,/g, '')) || 0,
                        trustSell: parseInt(stockData[6].replace(/,/g, '')) || 0,
                        trustNet: parseInt(stockData[7].replace(/,/g, '')) || 0,
                        dealerNet: parseInt(stockData[8].replace(/,/g, '')) || 0,
                        dealerSelfBuy: parseInt(stockData[9].replace(/,/g, '')) || 0,
                        dealerSelfSell: parseInt(stockData[10].replace(/,/g, '')) || 0,
                        dealerSelfNet: parseInt(stockData[11].replace(/,/g, '')) || 0,
                        dealerHedgeBuy: parseInt(stockData[12].replace(/,/g, '')) || 0,
                        dealerHedgeSell: parseInt(stockData[13].replace(/,/g, '')) || 0,
                        dealerHedgeNet: parseInt(stockData[14].replace(/,/g, '')) || 0,
                        totalNet: parseInt(stockData[15].replace(/,/g, '')) || 0
                    };
                }
            }
            return null;
        } catch (e) {
            console.error('ç²å–ä¸‰å¤§æ³•äººè³‡æ–™å¤±æ•—:', e);
            return null;
        }
    }
    
    // ç²å–èè³‡èåˆ¸è³‡æ–™
    async function fetchMarginData(stockCode, date) {
        const dateStr = date.replace(/-/g, '');
        const url = `https://www.twse.com.tw/rwd/zh/marginTrading/MI_MARGN?date=${dateStr}&selectType=ALL&response=json`;
        
        try {
            const data = await fetchWithProxy(url);
            if (data && data.tables && data.tables[1] && data.tables[1].data) {
                const stockData = data.tables[1].data.find(row => row[0] === stockCode);
                if (stockData) {
                    return {
                        marginBuyToday: parseInt(stockData[2].replace(/,/g, '')) || 0,
                        marginSellToday: parseInt(stockData[3].replace(/,/g, '')) || 0,
                        marginCashRepay: parseInt(stockData[4].replace(/,/g, '')) || 0,
                        marginBuyBalance: parseInt(stockData[5].replace(/,/g, '')) || 0,
                        marginBuyChange: parseInt(stockData[6].replace(/,/g, '')) || 0,
                        shortSellToday: parseInt(stockData[8].replace(/,/g, '')) || 0,
                        shortBuyToday: parseInt(stockData[9].replace(/,/g, '')) || 0,
                        shortStockRepay: parseInt(stockData[10].replace(/,/g, '')) || 0,
                        shortSellBalance: parseInt(stockData[11].replace(/,/g, '')) || 0,
                        shortSellChange: parseInt(stockData[12].replace(/,/g, '')) || 0,
                        marginRatio: stockData[13] || '--'
                    };
                }
            }
            return null;
        } catch (e) {
            console.error('ç²å–èè³‡èåˆ¸è³‡æ–™å¤±æ•—:', e);
            return null;
        }
    }
    
    // æ ¼å¼åŒ–æ•¸å­—é¡¯ç¤º
    function formatChipNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '--';
        const absNum = Math.abs(num);
        let formatted;
        if (absNum >= 10000) {
            formatted = (num / 1000).toFixed(0) + 'K';
        } else {
            formatted = num.toLocaleString();
        }
        return num > 0 ? '+' + formatted : formatted;
    }
    
    // ç²å–æ•¸å€¼çš„ CSS é¡åˆ¥
    function getValueClass(num) {
        if (num > 0) return 'positive';
        if (num < 0) return 'negative';
        return '';
    }
    
    // åˆ†æç±Œç¢¼è¨Šè™Ÿ
    function analyzeChipSignals(instData, marginData) {
        const signals = {
            institutional: { text: 'ä¸­æ€§', class: 'neutral' },
            retail: { text: 'è§€æœ›', class: 'neutral' },
            squeeze: { text: 'ä½', class: 'neutral' },
            concentration: { text: 'ä¸€èˆ¬', class: 'neutral' }
        };
        
        if (instData) {
            // æ³•äººæ…‹åº¦
            if (instData.totalNet > 1000) {
                signals.institutional = { text: 'ç©æ¥µè²·è¶… ğŸ“ˆ', class: 'positive' };
            } else if (instData.totalNet > 0) {
                signals.institutional = { text: 'å°å¹…è²·è¶…', class: 'positive' };
            } else if (instData.totalNet < -1000) {
                signals.institutional = { text: 'å¤§å¹…è³£è¶… ğŸ“‰', class: 'negative' };
            } else if (instData.totalNet < 0) {
                signals.institutional = { text: 'å°å¹…è³£è¶…', class: 'negative' };
            }
        }
        
        if (marginData) {
            // æ•£æˆ¶å‹•å‘ï¼ˆèè³‡å¢åŠ ä»£è¡¨æ•£æˆ¶è²·é€²ï¼‰
            if (marginData.marginBuyChange > 500) {
                signals.retail = { text: 'ç©æ¥µè¿½è²·', class: 'negative' }; // æ•£æˆ¶è¿½è²·é€šå¸¸ä¸æ˜¯å¥½è¨Šè™Ÿ
            } else if (marginData.marginBuyChange > 0) {
                signals.retail = { text: 'å°å¹…è²·é€²', class: 'neutral' };
            } else if (marginData.marginBuyChange < -500) {
                signals.retail = { text: 'å¤§é‡æ¸›ç¢¼', class: 'positive' }; // æ•£æˆ¶é›¢å ´å¯èƒ½æ˜¯å¥½è¨Šè™Ÿ
            } else if (marginData.marginBuyChange < 0) {
                signals.retail = { text: 'å°å¹…æ¸›ç¢¼', class: 'neutral' };
            }
            
            // è»‹ç©ºé¢¨éšª
            const shortRatio = marginData.shortSellBalance / (marginData.marginBuyBalance || 1) * 100;
            if (shortRatio > 30) {
                signals.squeeze = { text: 'é«˜ âš ï¸', class: 'positive' };
            } else if (shortRatio > 15) {
                signals.squeeze = { text: 'ä¸­ç­‰', class: 'neutral' };
            } else {
                signals.squeeze = { text: 'ä½', class: 'neutral' };
            }
        }
        
        // ç±Œç¢¼é›†ä¸­åº¦
        if (instData && instData.foreignNet > 0 && instData.trustNet > 0) {
            signals.concentration = { text: 'æ³•äººåŒæ­¥è²· âœ…', class: 'positive' };
        } else if (instData && instData.foreignNet < 0 && instData.trustNet < 0) {
            signals.concentration = { text: 'æ³•äººåŒæ­¥è³£ âŒ', class: 'negative' };
        } else {
            signals.concentration = { text: 'æ³•äººçœ‹æ³•åˆ†æ­§', class: 'neutral' };
        }
        
        return signals;
    }
    
    // æ›´æ–°ç±Œç¢¼é¡¯ç¤º
    function updateChipDisplay(instData, marginData, borrowData) {
        currentChipData = { instData, marginData, borrowData };
        
        // æ›´æ–°æ‘˜è¦
        if (instData) {
            document.getElementById('chip-foreign').textContent = formatChipNumber(instData.foreignNet);
            document.getElementById('chip-foreign').className = 'chip-summary-value';
            
            document.getElementById('chip-trust').textContent = formatChipNumber(instData.trustNet);
            document.getElementById('chip-dealer').textContent = formatChipNumber(instData.dealerNet || (instData.dealerSelfNet + instData.dealerHedgeNet));
            document.getElementById('chip-total').textContent = formatChipNumber(instData.totalNet);
            
            // æ›´æ–°æ˜ç´°
            document.getElementById('foreign-net').textContent = formatChipNumber(instData.foreignNet);
            document.getElementById('foreign-net').className = 'chip-data-value ' + getValueClass(instData.foreignNet);
            
            document.getElementById('foreign-dealer-net').textContent = formatChipNumber(instData.dealerHedgeNet);
            document.getElementById('foreign-dealer-net').className = 'chip-data-value ' + getValueClass(instData.dealerHedgeNet);
            
            document.getElementById('trust-net').textContent = formatChipNumber(instData.trustNet);
            document.getElementById('trust-net').className = 'chip-data-value ' + getValueClass(instData.trustNet);
            
            document.getElementById('dealer-self-net').textContent = formatChipNumber(instData.dealerSelfNet);
            document.getElementById('dealer-self-net').className = 'chip-data-value ' + getValueClass(instData.dealerSelfNet);
            
            document.getElementById('dealer-hedge-net').textContent = formatChipNumber(instData.dealerHedgeNet);
            document.getElementById('dealer-hedge-net').className = 'chip-data-value ' + getValueClass(instData.dealerHedgeNet);
        }
        
        // æ›´æ–°èè³‡èåˆ¸
        if (marginData) {
            document.getElementById('margin-buy-balance').textContent = marginData.marginBuyBalance.toLocaleString();
            document.getElementById('margin-buy-change').textContent = formatChipNumber(marginData.marginBuyChange);
            document.getElementById('margin-buy-change').className = 'chip-data-value ' + getValueClass(marginData.marginBuyChange);
            
            document.getElementById('margin-sell-balance').textContent = marginData.shortSellBalance.toLocaleString();
            document.getElementById('margin-sell-change').textContent = formatChipNumber(marginData.shortSellChange);
            document.getElementById('margin-sell-change').className = 'chip-data-value ' + getValueClass(marginData.shortSellChange);
            
            document.getElementById('margin-ratio').textContent = marginData.marginRatio;
        }
        
        // æ›´æ–°è¨Šè™Ÿ
        const signals = analyzeChipSignals(instData, marginData);
        document.getElementById('signal-institutional').innerHTML = signals.institutional.text;
        document.getElementById('signal-institutional').className = 'chip-data-value ' + signals.institutional.class;
        
        document.getElementById('signal-retail').innerHTML = signals.retail.text;
        document.getElementById('signal-retail').className = 'chip-data-value ' + signals.retail.class;
        
        document.getElementById('signal-squeeze').innerHTML = signals.squeeze.text;
        document.getElementById('signal-squeeze').className = 'chip-data-value ' + signals.squeeze.class;
        
        document.getElementById('signal-concentration').innerHTML = signals.concentration.text;
        document.getElementById('signal-concentration').className = 'chip-data-value ' + signals.concentration.class;
    }
    
    // ä½¿ç”¨ AI åˆ†æç±Œç¢¼ï¼ˆå‚™æ´æ–¹æ¡ˆï¼‰
    async function fetchChipDataWithAI(stockCode, stockName) {
        if (!userApiKey) {
            throw new Error("è«‹å…ˆè¨­å®š Gemini API é‡‘é‘°");
        }
        
        const prompt = `è«‹æœå°‹ä¸¦åˆ†æå°è‚¡ ${stockCode} ${stockName} æœ€è¿‘çš„ç±Œç¢¼è³‡è¨Šï¼ŒåŒ…å«ï¼š

1. ä¸‰å¤§æ³•äººè²·è³£è¶…ï¼ˆå¤–è³‡ã€æŠ•ä¿¡ã€è‡ªç‡Ÿå•†ï¼‰
2. èè³‡èåˆ¸é¤˜é¡è®ŠåŒ–
3. è¿‘æœŸä¸»åŠ›å‹•å‘

è«‹æä¾›ï¼š
- å…·é«”çš„æ•¸æ“šï¼ˆå¦‚æœ‰ï¼‰
- ç±Œç¢¼é¢çš„å¤šç©ºåˆ¤æ–·
- æ˜¯å¦æœ‰ç•°å¸¸ç±Œç¢¼è®ŠåŒ–
- æŠ•è³‡å»ºè­°

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œæ¢åˆ—å¼å‘ˆç¾é‡é»ã€‚`;

        const result = await callGroundedGeminiApi(prompt);
        return result;
    }
    
    // ä¸»è¦è¼‰å…¥å‡½æ•¸ - ç›´æ¥ä½¿ç”¨ AI ç¶²è·¯æœå°‹
    async function loadChipData() {
        if (!originalStockData || originalStockData.length === 0) {
            alert('è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™');
            return;
        }
        
        if (!userApiKey) {
            alert('è«‹å…ˆè¨­å®š Gemini API é‡‘é‘°');
            return;
        }
        
        const stockCode = originalStockData[0].stockCode;
        const stockName = originalStockData[0].stockName;
        
        chipLoader.style.display = 'block';
        chipPlaceholder.style.display = 'none';
        chipAnalysisResult.style.display = 'none';
        
        try {
            // ä½¿ç”¨ AI æœå°‹ç±Œç¢¼è³‡æ–™
            const prompt = `è«‹æœå°‹å°è‚¡ ${stockCode} ${stockName} æœ€æ–°çš„ç±Œç¢¼è³‡æ–™ï¼Œæä¾›ä»¥ä¸‹è³‡è¨Šï¼š

ğŸ“Š **ä¸‰å¤§æ³•äººè²·è³£è¶…**ï¼ˆè«‹æä¾›å…·é«”å¼µæ•¸ï¼‰
- å¤–è³‡è²·è³£è¶…
- æŠ•ä¿¡è²·è³£è¶…  
- è‡ªç‡Ÿå•†è²·è³£è¶…
- ä¸‰å¤§æ³•äººåˆè¨ˆ

ğŸ’³ **èè³‡èåˆ¸**
- èè³‡é¤˜é¡èˆ‡å¢æ¸›
- èåˆ¸é¤˜é¡èˆ‡å¢æ¸›
- åˆ¸è³‡æ¯”

ğŸ“… **è¿‘5æ—¥ä¸‰å¤§æ³•äººå‹•å‘**ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰

ğŸ¯ **ç±Œç¢¼é¢åˆ¤æ–·**
- æ³•äººæ…‹åº¦ï¼ˆåå¤š/åç©º/ä¸­æ€§ï¼‰
- ç±Œç¢¼æ˜¯å¦é›†ä¸­
- æœ‰ç„¡ç•°å¸¸è¨Šè™Ÿ

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œæ•¸æ“šè¦å…·é«”æº–ç¢ºã€‚`;

            const aiResult = await callGroundedGeminiApi(prompt);
            
            // é¡¯ç¤º AI çµæœ
            document.getElementById('chip-ai-content').innerHTML = aiResult.text.replace(/\n/g, '<br>');
            document.getElementById('chip-ai-result').style.display = 'block';
            document.getElementById('chip-data-date').textContent = `ğŸ¤– AI å³æ™‚æœå°‹ | ${new Date().toLocaleString()}`;
            
            // éš±è—ç©ºçš„æ•¸æ“šå¡ç‰‡ï¼Œåªé¡¯ç¤º AI çµæœ
            document.querySelectorAll('.chip-analysis-container .chip-card').forEach(card => {
                card.style.display = 'none';
            });
            document.getElementById('chip-summary-box').style.display = 'none';
            // éš±è—æ­·å²è¡¨æ ¼
            const historyCards = document.querySelectorAll('.chip-card');
            historyCards.forEach(card => {
                if (card.querySelector('#chip-history-body')) {
                    card.style.display = 'none';
                }
            });
            
            chipAnalysisResult.style.display = 'block';
            
        } catch (error) {
            console.error('è¼‰å…¥ç±Œç¢¼è³‡æ–™å¤±æ•—:', error);
            alert('è¼‰å…¥ç±Œç¢¼è³‡æ–™å¤±æ•—ï¼š' + error.message);
            chipPlaceholder.style.display = 'block';
        } finally {
            chipLoader.style.display = 'none';
        }
    }
    
    // AI ç±Œç¢¼æ·±åº¦åˆ†æ
    async function runAIChipAnalysis() {
        if (!originalStockData || originalStockData.length === 0) {
            alert('è«‹å…ˆè¼‰å…¥è‚¡ç¥¨è³‡æ–™');
            return;
        }
        
        if (!userApiKey) {
            alert('è«‹å…ˆè¨­å®š Gemini API é‡‘é‘°');
            return;
        }
        
        const stockCode = originalStockData[0].stockCode;
        const stockName = originalStockData[0].stockName;
        
        chipLoader.style.display = 'block';
        
        try {
            let chipContext = '';
            if (currentChipData && currentChipData.instData) {
                const inst = currentChipData.instData;
                chipContext = `
å·²çŸ¥ç±Œç¢¼è³‡æ–™ï¼š
- å¤–è³‡è²·è³£è¶…ï¼š${inst.foreignNet} å¼µ
- æŠ•ä¿¡è²·è³£è¶…ï¼š${inst.trustNet} å¼µ  
- è‡ªç‡Ÿå•†è²·è³£è¶…ï¼š${inst.dealerSelfNet + inst.dealerHedgeNet} å¼µ
- ä¸‰å¤§æ³•äººåˆè¨ˆï¼š${inst.totalNet} å¼µ
`;
            }
            
            const prompt = `ä½œç‚ºå°ˆæ¥­çš„å°è‚¡ç±Œç¢¼åˆ†æå¸«ï¼Œè«‹é‡å° ${stockCode} ${stockName} é€²è¡Œå®Œæ•´çš„ç±Œç¢¼åˆ†æï¼š

${chipContext}

è«‹æœå°‹æœ€æ–°è³‡è¨Šä¸¦åˆ†æï¼š

1. **ä¸‰å¤§æ³•äººå‹•å‘**
   - è¿‘5æ—¥å¤–è³‡è²·è³£è¶…è¶¨å‹¢
   - æŠ•ä¿¡æ˜¯å¦æœ‰é€£çºŒè²·è¶…/è³£è¶…
   - è‡ªç‡Ÿå•†é¿éšªéƒ¨ä½è®ŠåŒ–

2. **èè³‡èåˆ¸åˆ†æ**
   - èè³‡ä½¿ç”¨ç‡è®ŠåŒ–
   - èåˆ¸é¤˜é¡èˆ‡è»‹ç©ºé¢¨éšª
   - åˆ¸è³‡æ¯”åˆ¤è®€

3. **ä¸»åŠ›é€²å‡ºç ”åˆ¤**
   - åˆ†é»é€²å‡ºç•°å¸¸
   - å¤§æˆ¶æŒè‚¡è®ŠåŒ–

4. **ç±Œç¢¼é¢ç¶œåˆè©•ä¼°**
   - ç±Œç¢¼æ˜¯å¦é›†ä¸­
   - å¤šç©ºåŠ›é“æ¯”è¼ƒ
   - çŸ­æœŸèµ°å‹¢é åˆ¤

5. **æ“ä½œå»ºè­°**
   - é€²å ´æ™‚æ©Ÿ
   - é¢¨éšªæé†’

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œé‡é»æ¢åˆ—ï¼Œæ•¸æ“šè¦å…·é«”ã€‚`;

            const result = await callGroundedGeminiApi(prompt);
            
            document.getElementById('chip-ai-content').innerHTML = result.text.replace(/\n/g, '<br>');
            document.getElementById('chip-ai-result').style.display = 'block';
            chipAnalysisResult.style.display = 'block';
            chipPlaceholder.style.display = 'none';
            
        } catch (error) {
            console.error('AI ç±Œç¢¼åˆ†æå¤±æ•—:', error);
            alert('AI ç±Œç¢¼åˆ†æå¤±æ•—ï¼š' + error.message);
        } finally {
            chipLoader.style.display = 'none';
        }
    }
    
    // ç¶å®šäº‹ä»¶
    fetchChipDataBtn?.addEventListener('click', loadChipData);
    aiChipAnalysisBtn?.addEventListener('click', runAIChipAnalysis);

    // --- 5. Utility Functions (TTS, Export, Storage) ---

    async function playTTS() {
        if (ttsBtn.classList.contains('loading')) return;

        if (currentAudio && !currentAudio.paused) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            return;
        }
        
        const text = aiResultDiv.textContent;
        if (!text || !userApiKey) {
            alert("è«‹å…ˆç”¢ç”Ÿåˆ†æçµæœä¸¦è¨­å®š API é‡‘é‘°ã€‚");
            return;
        }

        ttsBtn.classList.add('loading');
        ttsBtn.disabled = true;

        try {
            const audioUrl = await callTtsApi(text);
            currentAudio = new Audio(audioUrl);
            currentAudio.play();
            
            const cleanup = () => {
                ttsBtn.classList.remove('loading');
                ttsBtn.disabled = false;
                currentAudio.removeEventListener('ended', cleanup);
                currentAudio.removeEventListener('error', cleanup);
            };
            
            currentAudio.addEventListener('ended', cleanup);
            currentAudio.addEventListener('error', cleanup);

        } catch (error) {
            console.error("TTS æ’­æ”¾å¤±æ•—:", error);
            alert("èªéŸ³æ’­æ”¾å¤±æ•—ï¼š" + error.message);
            ttsBtn.classList.remove('loading');
            ttsBtn.disabled = false;
        }
    }

    async function callTtsApi(text) {
        if (!userApiKey) {
            throw new Error("å°šæœªè¨­å®š Gemini API é‡‘é‘°ï¼Œè«‹åœ¨ AI åˆ†æå€å¡Šä¸­è¼¸å…¥ä¸¦å„²å­˜ã€‚");
        }
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${userApiKey}`;
        const payload = {
            contents: [{ parts: [{ text: `ç”¨å°ˆæ¥­ä¸”æ¸…æ™°çš„èªæ°£èªª: ${text}` }] }],
            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } } } },
            model: "gemini-2.5-flash-preview-tts"
        };
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`TTS API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š ${response.status}`);
        
        const result = await response.json();
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType;

        if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const base64ToArrayBuffer = (base64) => {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
                return bytes.buffer;
            };
            const pcmToWav = (pcmData, sampleRate) => {
                const header = new ArrayBuffer(44);
                const view = new DataView(header);
                const writeString = (view, offset, string) => { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); }};
                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + pcmData.byteLength, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(view, 36, 'data');
                view.setUint32(40, pcmData.byteLength, true);
                return new Blob([view, pcmData], { type: 'audio/wav' });
            };
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)?.[1] || "24000", 10);
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            return URL.createObjectURL(wavBlob);
        } else {
            throw new Error('API å›æ‡‰ä¸­æœªåŒ…å«æœ‰æ•ˆçš„éŸ³è¨Šè³‡æ–™ã€‚');
        }
    }
    
    function downloadMarkdown(elementId, filenamePrefix) {
        const contentEl = document.getElementById(elementId);
        if (!contentEl || !contentEl.innerHTML) {
            alert('æ²’æœ‰å¯ä¸‹è¼‰çš„å…§å®¹ã€‚');
            return;
        }

        let markdownContent = contentEl.innerHTML;

        // Convert <br> back to newlines
        markdownContent = markdownContent.replace(/<br\s*\/?>/gi, '\n');
        
        // Handle colored spans from US Market report
        markdownContent = markdownContent.replace(/<span class="text-rise">(.*?)<\/span>/gi, '$1');
        markdownContent = markdownContent.replace(/<span class="text-fall">(.*?)<\/span>/gi, '$1');

        // Strip any other HTML tags that might have been injected
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = markdownContent;
        const plainText = tempDiv.textContent || tempDiv.innerText || "";
        
        const stockCode = originalStockData[0]?.stockCode || 'STOCK';
        const stockName = originalStockData[0]?.stockName || '';
        const filename = `${stockCode}_${stockName}_${filenamePrefix}.md`;

        const blob = new Blob([plainText], { type: 'text/markdown;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    async function generatePdfReport() {
        const adviceText = expertAdviceResult.textContent;
        if (!adviceText || adviceText.startsWith('é»æ“ŠæŒ‰éˆ•') || adviceText.startsWith('AI å°ˆå®¶å»ºè­°ç”Ÿæˆå¤±æ•—')) {
            alert('è«‹å…ˆæˆåŠŸç”Ÿæˆ AI å°ˆå®¶å»ºè­°å ±å‘Šã€‚');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        
        const loader = document.createElement('div');
        loader.textContent = 'æ­£åœ¨ç”Ÿæˆ PDF å ±å‘Š...';
        loader.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); color: var(--text-main); padding: 20px; border-radius: 10px; z-index: 1000;';
        document.body.appendChild(loader);

        const activeTab = document.querySelector('.tab-content.active');
        const allTabs = document.querySelectorAll('.tab-content');

        try {
            const stockName = originalStockData[0].stockName || '';
            const stockCode = originalStockData[0].stockCode || '';
            const reportTitle = `${stockName} (${stockCode}) AI å°ˆå®¶åˆ†æå ±å‘Š`;
            
            const textContainer = document.createElement('div');
            textContainer.innerHTML = `<h2>${reportTitle}</h2>` + expertAdviceResult.innerHTML;
            textContainer.style.cssText = 'width: 180mm; padding: 10px; color: black; background: white; position: absolute; left: -9999px; font-family: sans-serif;';
            document.body.appendChild(textContainer);
            
            const textCanvas = await html2canvas(textContainer, {scale: 2});
            const textImgData = textCanvas.toDataURL('image/png');
            
            const textImgProps = doc.getImageProperties(textImgData);
            const textImgWidth = 190;
            const textImgHeight = (textImgProps.height * textImgWidth) / textImgProps.width;
            
            doc.addImage(textImgData, 'PNG', 10, 15, textImgWidth, textImgHeight);
            
            document.body.removeChild(textContainer);

            const chartIds = ['main-chart', 'macd-chart', 'kd-chart', 'rsi-chart', 'mfi-chart', 'williams-r-chart'];
            
            const pdfChartTheme = {
                chart: { background: '#FFFFFF', foreColor: '#333333' },
                xaxis: { labels: { style: { colors: '#333333' } }, axisBorder: { color: '#CCCCCC' }, axisTicks: { color: '#CCCCCC' } },
                yaxis: { labels: { style: { colors: '#333333' } } },
                grid: { borderColor: '#E0E0E0' },
                tooltip: { theme: 'light' }
            };

            const originalTheme = {
                chart: { background: 'transparent', foreColor: 'var(--text-light)' },
                xaxis: { labels: { style: { colors: 'var(--text-light)' } }, axisBorder: { color: 'var(--border-color)' }, axisTicks: { color: 'var(--border-color)' } },
                yaxis: { labels: { style: { colors: 'var(--text-light)' } } },
                grid: { borderColor: 'var(--border-color)' },
                tooltip: { theme: 'dark' }
            };

            for (const chartId of chartIds) {
                const chart = charts[chartId];
                if (!chart) continue;
                
                // Use class manipulation instead of direct style for tab switching
                allTabs.forEach(tab => tab.classList.remove('active'));
                const parentTab = document.getElementById(chartId).closest('.tab-content');
                parentTab.classList.add('active');

                // Update chart options for better PDF rendering
                await chart.updateOptions({ ...pdfChartTheme, animations: { enabled: false } });

                await new Promise(resolve => setTimeout(resolve, 250)); 

                let imgURI;
                try {
                    const data = await chart.dataURI({ scale: 2 });
                    imgURI = data.imgURI;
                } catch(e) {
                    console.error(`Could not get data URI for chart ${chartId}`, e);
                }
                
                // Revert chart options for UI display
                await chart.updateOptions({ ...originalTheme, animations: { enabled: true } });

                if (!imgURI) {
                     console.error(`imgURI is empty for chart ${chartId}`);
                     continue;
                }

                doc.addPage();
                const imgProps = doc.getImageProperties(imgURI);
                const imgWidth = 190;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                doc.addImage(imgURI, 'PNG', 10, 20, imgWidth, imgHeight);
            }
            
            doc.save(`${stockCode}_AI_Report.pdf`);

        } catch (e) {
            console.error("PDF generation failed:", e);
            alert("ç”Ÿæˆ PDF å ±å‘Šæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚è«‹ç¢ºèªæ‰€æœ‰åœ–è¡¨å‡å·²æ­£ç¢ºè¼‰å…¥ã€‚");
        } finally {
            // Restore tab visibility using the class-based system
            allTabs.forEach(tab => {
                tab.style.display = ''; // Remove inline styles
                tab.classList.remove('active');
            });
            if (activeTab) {
                activeTab.classList.add('active');
            }
            if(document.body.contains(loader)) document.body.removeChild(loader);
        }
    }


    function exportData() {
        if (!originalStockData || originalStockData.length === 0) {
            alert("æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ã€‚");
            return;
        }

        const data = originalStockData;
        const stockCode = data[0].stockCode || 'UNKNOWN';
        const stockName = data[0].stockName || 'Stock';
        const lastDate = data[data.length - 1].rocDate;
        if (!lastDate) {
            alert("è³‡æ–™æ ¼å¼ä¸å®Œæ•´ï¼Œç„¡æ³•ç”¢ç”Ÿç¬¦åˆè¦ç¯„çš„ CSV æ¨™é ­ã€‚è«‹å…ˆé€éç·šä¸ŠæŸ¥è©¢è¼‰å…¥è³‡æ–™ã€‚");
            return;
        }

        const rocYear = lastDate.split('/')[0];
        const header1 = `"${rocYear}å¹´ ${stockCode} ${stockName}",,,,,,,,`;
        const header2 = `"æ—¥æœŸ","æˆäº¤è‚¡æ•¸","æˆäº¤é‡‘é¡","é–‹ç›¤åƒ¹","æœ€é«˜åƒ¹","æœ€ä½åƒ¹","æ”¶ç›¤åƒ¹","æ¼²è·Œåƒ¹å·®","æˆäº¤ç­†æ•¸"`;
        
        const rows = data.map(d => {
            const rowData = [
                d.rocDate, d.volume, d.amount, d.open, d.high, d.low, d.close, d.change, d.transactions
            ];
            return rowData.map(field => `"${String(field === null || field === undefined ? '' : field).trim()}"`).join(',');
        });

        const csvContent = [header1, header2, ...rows].join('\n');
        
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const filename = `${stockCode}_${stockName}.csv`;
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function saveDataToStorage() {
        try { localStorage.setItem('stockData', JSON.stringify(originalStockData)); } catch (e) { console.error('å„²å­˜è³‡æ–™å¤±æ•—:', e); }
    }

    function loadStoredData() {
        try {
            const stored = localStorage.getItem('stockData');
            if (stored) {
                originalStockData = JSON.parse(stored);
                return originalStockData.length > 0;
            }
        } catch (e) {
            console.error('è®€å–å„²å­˜è³‡æ–™å¤±æ•—:', e);
            originalStockData = [];
        }
        return false;
    }
</script>
</body>
</html>


